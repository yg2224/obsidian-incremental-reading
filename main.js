/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// src/main.ts
var main_exports = {};
__export(main_exports, {
  default: () => IncrementalReadingPlugin
});
module.exports = __toCommonJS(main_exports);
var import_obsidian10 = require("obsidian");

// src/views/IncrementalReadingView.ts
var import_obsidian4 = require("obsidian");

// src/components/Modal.ts
var import_obsidian = require("obsidian");
var DocumentMetricsModal = class extends import_obsidian.Modal {
  constructor(app, file, metrics, customMetrics, onSave, onRealTimeUpdate) {
    super(app);
    // Real-time update callback
    this.sliders = /* @__PURE__ */ new Map();
    this.valueDisplays = /* @__PURE__ */ new Map();
    this.isProcessing = false;
    this.file = file;
    this.initialMetrics = { ...metrics };
    this.customMetrics = customMetrics;
    this.onSave = onSave;
    this.onRealTimeUpdate = onRealTimeUpdate;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("incremental-reading-plugin-root");
    contentEl.addClass("incremental-reading-modal", "document-metrics-modal");
    contentEl.createEl("h2", {
      text: `\u8C03\u6574\u6587\u6863\u5F97\u5206: ${this.file.basename || "\u672A\u77E5\u6587\u6863"}`
    });
    const sliderContainer = contentEl.createEl("div", { cls: "sliders-container" });
    for (const metric of this.customMetrics) {
      const config = {
        key: metric.id,
        label: `${metric.name} (${metric.weight}%)`,
        min: 0,
        max: 10,
        step: 0.5
      };
      const sliderGroup = sliderContainer.createEl("div", { cls: "slider-group" });
      const labelRow = sliderGroup.createEl("div", { cls: "label-row" });
      labelRow.createEl("label", {
        text: config.label,
        cls: "metric-label"
      });
      const valueDisplay = labelRow.createEl("span", {
        text: (this.initialMetrics[config.key] || 5).toFixed(1),
        cls: "value-display"
      });
      this.valueDisplays.set(config.key, valueDisplay);
      const slider = sliderGroup.createEl("input", {
        type: "range",
        cls: "slider"
      });
      slider.min = config.min.toString();
      slider.max = config.max.toString();
      slider.step = config.step.toString();
      slider.value = (this.initialMetrics[config.key] || 5).toString();
      this.sliders.set(config.key, slider);
      slider.addEventListener("input", async () => {
        const value = parseFloat(slider.value);
        valueDisplay.textContent = value.toFixed(1);
        if (this.onRealTimeUpdate) {
          const currentMetrics = { ...this.initialMetrics };
          for (const [key, sliderElement] of this.sliders) {
            currentMetrics[key] = parseFloat(sliderElement.value);
          }
          try {
            await this.onRealTimeUpdate(currentMetrics);
          } catch (error) {
            console.warn("Real-time update failed:", error);
          }
        }
      });
    }
    const buttonContainer = contentEl.createEl("div", { cls: "modal-button-container" });
    const confirmBtn = buttonContainer.createEl("button", {
      text: "\u4FDD\u5B58",
      cls: "mod-cta"
    });
    const cancelBtn = buttonContainer.createEl("button", {
      text: "\u53D6\u6D88",
      cls: "mod-cancel"
    });
    confirmBtn.onclick = async () => {
      if (this.isProcessing)
        return;
      try {
        this.isProcessing = true;
        confirmBtn.textContent = "\u4FDD\u5B58\u4E2D...";
        confirmBtn.disabled = true;
        cancelBtn.disabled = true;
        const updatedMetrics = { ...this.initialMetrics };
        for (const [key, slider] of this.sliders) {
          updatedMetrics[key] = parseFloat(slider.value);
        }
        await this.onSave(updatedMetrics);
        this.close();
      } catch (error) {
        console.error("\u4FDD\u5B58\u6587\u6863\u5F97\u5206\u5931\u8D25:", error);
        new import_obsidian.Notice("\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5");
        confirmBtn.textContent = "\u4FDD\u5B58";
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
      } finally {
        this.isProcessing = false;
      }
    };
    cancelBtn.onclick = () => this.close();
    this.scope.register([], "Enter", () => confirmBtn.click());
    this.scope.register([], "Escape", () => cancelBtn.click());
    setTimeout(() => {
      var _a;
      return (_a = this.sliders.values().next().value) == null ? void 0 : _a.focus();
    }, 100);
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.removeClass("incremental-reading-modal", "document-metrics-modal");
  }
};
var FolderSelectionModal = class extends import_obsidian.Modal {
  constructor(app, onConfirm) {
    super(app);
    this.folderList = null;
    this.selectedFolders = /* @__PURE__ */ new Set();
    this.isProcessing = false;
    this.onConfirm = onConfirm;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("incremental-reading-plugin-root");
    contentEl.addClass("incremental-reading-modal", "folder-selection-modal");
    contentEl.createEl("h2", { text: "\u9009\u62E9\u6587\u4EF6\u5939" });
    contentEl.createEl("p", {
      text: "\u9009\u62E9\u8981\u6DFB\u52A0\u5230\u6F2B\u6E38\u5217\u8868\u7684\u6587\u4EF6\u5939\uFF08\u9012\u5F52\u5305\u542B\u6240\u6709Markdown\u6587\u4EF6\uFF09",
      cls: "instruction-text"
    });
    const listContainer = contentEl.createEl("div", { cls: "folder-list-container" });
    this.folderList = listContainer.createEl("div", { cls: "folder-list" });
    this.populateFolderList();
    const buttonContainer = contentEl.createEl("div", { cls: "modal-button-container" });
    const confirmBtn = buttonContainer.createEl("button", {
      text: "\u6DFB\u52A0\u9009\u4E2D\u6587\u4EF6\u5939",
      cls: "mod-cta"
    });
    const cancelBtn = buttonContainer.createEl("button", {
      text: "\u53D6\u6D88",
      cls: "mod-cancel"
    });
    confirmBtn.onclick = async () => {
      if (this.isProcessing)
        return;
      try {
        this.isProcessing = true;
        confirmBtn.textContent = "\u6DFB\u52A0\u4E2D...";
        confirmBtn.disabled = true;
        cancelBtn.disabled = true;
        await this.onConfirm(Array.from(this.selectedFolders));
        this.close();
      } catch (error) {
        console.error("\u6DFB\u52A0\u6587\u4EF6\u5939\u5931\u8D25:", error);
        new import_obsidian.Notice("\u6DFB\u52A0\u6587\u4EF6\u5939\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5");
        confirmBtn.textContent = "\u6DFB\u52A0\u9009\u4E2D\u6587\u4EF6\u5939";
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
      } finally {
        this.isProcessing = false;
      }
    };
    cancelBtn.onclick = () => this.close();
    this.scope.register([], "Escape", () => cancelBtn.click());
  }
  populateFolderList() {
    if (!this.folderList)
      return;
    this.folderList.empty();
    const files = this.app.vault.getAllLoadedFiles();
    const folders = files.filter((file) => file instanceof import_obsidian.TFolder);
    folders.sort((a, b) => a.path.localeCompare(b.path));
    folders.forEach((folder) => {
      const folderItem = this.folderList.createEl("div", { cls: "folder-item" });
      const checkbox = folderItem.createEl("input", {
        type: "checkbox",
        cls: "folder-checkbox"
      });
      const label = folderItem.createEl("label", {
        text: folder.path || "(\u6839\u76EE\u5F55)",
        cls: "folder-label"
      });
      folderItem.onclick = (e) => {
        if (e.target !== checkbox) {
          checkbox.checked = !checkbox.checked;
        }
        this.toggleFolder(folder.path, checkbox.checked);
      };
      checkbox.onchange = () => {
        this.toggleFolder(folder.path, checkbox.checked);
      };
    });
  }
  toggleFolder(folderPath, selected) {
    if (selected) {
      this.selectedFolders.add(folderPath);
    } else {
      this.selectedFolders.delete(folderPath);
    }
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.removeClass("incremental-reading-modal", "folder-selection-modal");
  }
};
var MultiFileSelectionModal = class extends import_obsidian.Modal {
  constructor(app, onConfirm) {
    super(app);
    this.fileList = null;
    this.selectedFiles = /* @__PURE__ */ new Set();
    this.availableFiles = [];
    this.isProcessing = false;
    this.searchInput = null;
    this.onConfirm = onConfirm;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("incremental-reading-plugin-root");
    contentEl.addClass("incremental-reading-modal", "multi-file-selection-modal");
    contentEl.createEl("h2", { text: "\u591A\u9009\u6587\u4EF6" });
    contentEl.createEl("p", {
      text: "\u9009\u62E9\u8981\u6DFB\u52A0\u5230\u6F2B\u6E38\u5217\u8868\u7684Markdown\u6587\u4EF6\uFF08\u652F\u6301Ctrl+\u70B9\u51FB\u591A\u9009\uFF09",
      cls: "instruction-text"
    });
    const searchContainer = contentEl.createEl("div", { cls: "search-container" });
    this.searchInput = searchContainer.createEl("input", {
      type: "text",
      placeholder: "\u641C\u7D22\u6587\u4EF6...",
      cls: "search-input"
    });
    this.searchInput.addEventListener("input", () => this.filterFiles());
    const listContainer = contentEl.createEl("div", { cls: "file-list-container" });
    this.fileList = listContainer.createEl("div", { cls: "file-list" });
    this.populateFileList();
    const selectionInfo = contentEl.createEl("div", { cls: "selection-info" });
    selectionInfo.textContent = "\u5DF2\u9009\u62E9 0 \u4E2A\u6587\u4EF6";
    const buttonContainer = contentEl.createEl("div", { cls: "modal-button-container" });
    const confirmBtn = buttonContainer.createEl("button", {
      text: "\u6DFB\u52A0\u9009\u4E2D\u6587\u4EF6",
      cls: "mod-cta"
    });
    const cancelBtn = buttonContainer.createEl("button", {
      text: "\u53D6\u6D88",
      cls: "mod-cancel"
    });
    confirmBtn.onclick = async () => {
      if (this.isProcessing)
        return;
      try {
        this.isProcessing = true;
        confirmBtn.textContent = "\u6DFB\u52A0\u4E2D...";
        confirmBtn.disabled = true;
        cancelBtn.disabled = true;
        const selectedFileObjects = this.availableFiles.filter(
          (file) => this.selectedFiles.has(file.path)
        );
        await this.onConfirm(selectedFileObjects);
        this.close();
      } catch (error) {
        console.error("\u6DFB\u52A0\u6587\u4EF6\u5931\u8D25:", error);
        new import_obsidian.Notice("\u6DFB\u52A0\u6587\u4EF6\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5");
        confirmBtn.textContent = "\u6DFB\u52A0\u9009\u4E2D\u6587\u4EF6";
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
      } finally {
        this.isProcessing = false;
      }
    };
    cancelBtn.onclick = () => this.close();
    this.updateSelectionInfo = this.updateSelectionInfo.bind(this, selectionInfo);
    this.scope.register([], "Escape", () => cancelBtn.click());
    setTimeout(() => {
      var _a;
      return (_a = this.searchInput) == null ? void 0 : _a.focus();
    }, 100);
  }
  populateFileList() {
    if (!this.fileList)
      return;
    this.fileList.empty();
    this.availableFiles = this.app.vault.getMarkdownFiles();
    this.availableFiles.sort((a, b) => a.path.localeCompare(b.path));
    this.availableFiles.forEach((file) => {
      const fileItem = this.fileList.createEl("div", { cls: "file-item" });
      const checkbox = fileItem.createEl("input", {
        type: "checkbox",
        cls: "file-checkbox"
      });
      const label = fileItem.createEl("label", {
        text: file.path,
        cls: "file-label"
      });
      fileItem.onclick = (e) => {
        if (e.target !== checkbox) {
          checkbox.checked = !checkbox.checked;
        }
        this.toggleFile(file.path, checkbox.checked);
      };
      checkbox.onchange = () => {
        this.toggleFile(file.path, checkbox.checked);
      };
    });
  }
  toggleFile(filePath, selected) {
    if (selected) {
      this.selectedFiles.add(filePath);
    } else {
      this.selectedFiles.delete(filePath);
    }
    this.updateSelectionInfo(document.querySelector(".selection-info"));
  }
  updateSelectionInfo(selectionInfo) {
    selectionInfo.textContent = `\u5DF2\u9009\u62E9 ${this.selectedFiles.size} \u4E2A\u6587\u4EF6`;
  }
  filterFiles() {
    if (!this.searchInput || !this.fileList)
      return;
    const searchTerm = this.searchInput.value.toLowerCase();
    const fileItems = this.fileList.querySelectorAll(".file-item");
    fileItems.forEach((item, index) => {
      const file = this.availableFiles[index];
      const matchesSearch = file.path.toLowerCase().includes(searchTerm);
      item.style.display = matchesSearch ? "block" : "none";
    });
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.removeClass("incremental-reading-modal", "multi-file-selection-modal");
  }
};

// src/views/components/ActionBar.ts
var ActionBar = class {
  constructor(container, plugin, callbacks) {
    this.continueBtn = null;
    this.addRoamingBtn = null;
    this.container = container;
    this.plugin = plugin;
    this.onContinueReading = callbacks.onContinueReading;
    this.onGetSmartRecommendations = callbacks.onGetSmartRecommendations;
    this.onRefreshData = callbacks.onRefreshData;
    this.onRandomRoaming = callbacks.onRandomRoaming;
    this.onAddCurrentToRoaming = callbacks.onAddCurrentToRoaming;
    this.create();
  }
  create() {
    const actionBar = this.container.createEl("div", { cls: "action-bar" });
    this.continueBtn = actionBar.createEl("button", {
      cls: "btn primary",
      text: "\u7EE7\u7EED\u6F2B\u6E38"
    });
    this.continueBtn.onclick = () => this.onContinueReading();
    this.updateContinueButtonState();
    const recommendBtn = actionBar.createEl("button", {
      cls: "btn",
      text: "\u{1F9E0} \u667A\u80FD\u63A8\u8350"
    });
    recommendBtn.title = "\u8DF3\u8F6C\u5230\u76F8\u4F3C\u5EA6\u6700\u9AD8\u7684\u6587\u6863";
    recommendBtn.onclick = () => this.onGetSmartRecommendations();
    const refreshDataBtn = actionBar.createEl("button", {
      cls: "btn",
      text: "\u72B6\u6001\u66F4\u65B0"
    });
    refreshDataBtn.onclick = () => this.onRefreshData();
    const randomRoamBtn = actionBar.createEl("button", {
      cls: "btn",
      text: "\u968F\u673A\u6F2B\u6E38"
    });
    randomRoamBtn.onclick = () => this.onRandomRoaming();
    this.addRoamingBtn = actionBar.createEl("button", {
      cls: "btn",
      text: "\u52A0\u5165\u6F2B\u6E38"
    });
    this.addRoamingBtn.onclick = () => this.onAddCurrentToRoaming();
    this.updateAddRoamingButtonState();
    const addFolderBtn = actionBar.createEl("button", {
      cls: "btn",
      text: "\u6DFB\u52A0\u6587\u4EF6\u5939"
    });
    addFolderBtn.onclick = () => this.addFolderToRoaming();
    const multiSelectBtn = actionBar.createEl("button", {
      cls: "btn",
      text: "\u591A\u9009\u6587\u4EF6"
    });
    multiSelectBtn.onclick = () => this.multiSelectFilesToRoaming();
  }
  addFolderToRoaming() {
    const folderModal = new FolderSelectionModal(this.plugin.app, async (folderPaths) => {
      await this.plugin.addFoldersToRoaming(folderPaths);
      this.onRefreshData();
    });
    folderModal.open();
  }
  multiSelectFilesToRoaming() {
    const fileModal = new MultiFileSelectionModal(this.plugin.app, async (files) => {
      await this.plugin.addMultipleFilesToRoaming(files);
      this.onRefreshData();
    });
    fileModal.open();
  }
  updateContinueButtonState() {
    if (!this.continueBtn)
      return;
    const validRoamingFiles = this.plugin.getValidRoamingFiles();
    const hasValidFiles = validRoamingFiles.length > 0;
    this.continueBtn.disabled = !hasValidFiles;
    this.continueBtn.textContent = hasValidFiles ? "\u7EE7\u7EED\u6F2B\u6E38" : "\u6682\u65E0\u6F2B\u6E38\u6587\u6863";
  }
  updateAddRoamingButtonState() {
    if (!this.addRoamingBtn)
      return;
    const activeFile = this.plugin.app.workspace.getActiveFile();
    const isInRoaming = activeFile && this.plugin.settings.roamingDocs.includes(activeFile.path);
    this.addRoamingBtn.disabled = isInRoaming;
    this.addRoamingBtn.textContent = isInRoaming ? "\u5DF2\u5728\u6F2B\u6E38\u4E2D" : "\u52A0\u5165\u6F2B\u6E38";
  }
  /**
   * 更新按钮状态（当文件变化时调用）
   */
  updateButtonStates() {
    this.updateContinueButtonState();
    this.updateAddRoamingButtonState();
  }
};

// src/views/components/DocumentMetrics.ts
var import_obsidian2 = require("obsidian");

// src/utils/SharedUtils.ts
var SharedUtils = class {
  /**
   * Calculate priority score for a document based on custom metrics and weights
   */
  static calculatePriority(metrics, weights, customMetrics) {
    let totalScore = 0;
    let totalWeight = 0;
    for (const metric of customMetrics) {
      const metricValue = metrics[metric.id] || 0;
      const metricWeight = weights[metric.id] || metric.weight;
      totalScore += metricValue * (metricWeight / 100);
      totalWeight += metricWeight / 100;
    }
    return totalWeight > 0 ? totalScore / totalWeight * 10 : 0;
  }
  /**
   * Safely get document metrics with defaults for custom metrics
   */
  static getDocumentMetrics(file, settings) {
    const filePath = file.path;
    const stored = settings.documentMetrics[filePath];
    if (stored) {
      return stored;
    }
    const defaultMetrics = {
      lastVisited: 0,
      visitCount: 0
    };
    for (const metric of settings.customMetrics) {
      defaultMetrics[metric.id] = 5;
    }
    return defaultMetrics;
  }
  /**
   * Update document metrics with validation
   */
  static updateDocumentMetrics(file, settings, metrics) {
    const filePath = file.path;
    const currentMetrics = this.getDocumentMetrics(file, settings);
    const updatedMetrics = {
      ...currentMetrics,
      ...metrics,
      lastVisited: Date.now()
    };
    const hasMetricUpdate = Object.keys(metrics).some(
      (key) => key !== "lastVisited" && key !== "visitCount" && metrics[key] !== void 0
    );
    if (hasMetricUpdate) {
      updatedMetrics.visitCount = currentMetrics.visitCount + 1;
    }
    return updatedMetrics;
  }
  /**
   * Check if file should be included based on excluded paths
   */
  static shouldIncludeFile(file, excludedPaths) {
    try {
      const excludedPatterns = excludedPaths.map(
        (pattern) => new RegExp(pattern.replace(/\*/g, ".*"), "i")
      );
      return !excludedPatterns.some((pattern) => pattern.test(file.path));
    } catch (error) {
      console.warn("Invalid regex pattern in excluded paths:", error);
      return true;
    }
  }
  /**
   * Get priority color based on score
   */
  static getPriorityColor(priority) {
    if (priority >= 8)
      return "#dc3545";
    if (priority >= 6)
      return "#fd7e14";
    if (priority >= 4)
      return "#ffc107";
    if (priority >= 2)
      return "#28a745";
    return "#6c757d";
  }
  /**
   * Safe JSON stringify with error handling
   */
  static safeStringify(obj) {
    try {
      return JSON.stringify(obj, null, 2);
    } catch (error) {
      console.error("Error stringifying object:", error);
      return "{}";
    }
  }
  /**
   * Safe JSON parse with error handling
   */
  static safeParse(json, defaultValue) {
    try {
      return JSON.parse(json);
    } catch (error) {
      console.error("Error parsing JSON:", error);
      return defaultValue;
    }
  }
  /**
   * Debounce function for performance optimization
   */
  static debounce(func, wait) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => func(...args), wait);
    };
  }
  /**
   * Validate metric values are within acceptable ranges for custom metrics
   */
  static validateMetrics(metrics, customMetrics) {
    const validated = {};
    for (const metric of customMetrics) {
      if (metrics[metric.id] !== void 0) {
        validated[metric.id] = Math.max(0, Math.min(10, Number(metrics[metric.id])));
      }
    }
    if (metrics.lastVisited !== void 0) {
      validated.lastVisited = Math.max(0, Number(metrics.lastVisited));
    }
    if (metrics.visitCount !== void 0) {
      validated.visitCount = Math.max(0, Math.floor(Number(metrics.visitCount)));
    }
    return validated;
  }
  /**
   * Validate settings values
   */
  static validateSettings(settings) {
    const validated = {};
    if (!settings) {
      return validated;
    }
    if (settings.excludeVisited !== void 0) {
      validated.excludeVisited = Boolean(settings.excludeVisited);
    }
    const isNewUser = !settings.version || settings.version !== "2.0.0";
    if (settings.roamingDocs !== void 0) {
      validated.roamingDocs = Array.isArray(settings.roamingDocs) ? settings.roamingDocs.filter((path) => typeof path === "string") : [];
    } else {
      validated.roamingDocs = [];
    }
    if (isNewUser && settings.visitedDocs && Array.isArray(settings.visitedDocs) && settings.visitedDocs.length > 0) {
      console.log(`\u53D1\u73B0 ${settings.visitedDocs.length} \u4E2A\u5386\u53F2\u8BBF\u95EE\u8BB0\u5F55\uFF0C\u8BF7\u4F7F\u7528"\u6DFB\u52A0\u81F3\u6F2B\u6E38"\u529F\u80FD\u624B\u52A8\u6DFB\u52A0\u9700\u8981\u7684\u6587\u6863`);
    }
    if (settings.excludedPaths !== void 0) {
      validated.excludedPaths = Array.isArray(settings.excludedPaths) ? settings.excludedPaths.filter((path) => typeof path === "string") : [];
    }
    if (settings.maxCandidates !== void 0) {
      validated.maxCandidates = Math.max(10, Math.min(1e3, Number(settings.maxCandidates)));
    }
    if (settings.customMetrics !== void 0 && Array.isArray(settings.customMetrics)) {
      validated.customMetrics = settings.customMetrics.filter(
        (metric) => metric && typeof metric.id === "string" && typeof metric.name === "string" && typeof metric.weight === "number"
      ).map((metric) => ({
        id: metric.id,
        name: metric.name,
        weight: Math.max(0, Math.min(100, metric.weight))
      }));
    } else {
      validated.customMetrics = [
        { id: "importance", name: "\u91CD\u8981\u6027", weight: 40 },
        { id: "urgency", name: "\u7D27\u6025\u5EA6", weight: 30 },
        { id: "completion", name: "\u5B8C\u6210\u5EA6", weight: 30 }
      ];
    }
    if (validated.customMetrics && validated.customMetrics.length > 0) {
      const totalWeight = validated.customMetrics.reduce((sum, metric) => sum + metric.weight, 0);
      if (totalWeight > 0) {
        validated.customMetrics = validated.customMetrics.map((metric) => ({
          ...metric,
          weight: Math.round(metric.weight / totalWeight * 100)
        }));
      }
    }
    if (validated.customMetrics) {
      validated.metricWeights = {};
      for (const metric of validated.customMetrics) {
        validated.metricWeights[metric.id] = metric.weight;
      }
    }
    return validated;
  }
  /**
   * Create a safe element getter with null checks
   */
  static safeElementQuery(container, selector) {
    if (!container)
      return null;
    try {
      return container.querySelector(selector);
    } catch (error) {
      console.warn("Invalid selector:", selector, error);
      return null;
    }
  }
  /**
   * Generate a unique ID for DOM elements
   */
  static generateId(prefix = "ir") {
    return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
  /**
   * Format file size in human readable format
   */
  static formatFileSize(bytes) {
    if (bytes === 0)
      return "0 B";
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  }
  /**
   * Truncate text with ellipsis
   */
  static truncateText(text, maxLength) {
    if (text.length <= maxLength)
      return text;
    return text.substr(0, maxLength - 3) + "...";
  }
  /**
   * Check if a value is a valid number
   */
  static isValidNumber(value) {
    return typeof value === "number" && !isNaN(value) && isFinite(value);
  }
};

// src/views/components/DocumentMetrics.ts
var DocumentMetricsDisplay = class {
  constructor(container, plugin, file, metrics, onMetricsUpdated) {
    this.container = container;
    this.plugin = plugin;
    this.file = file;
    this.metrics = metrics;
    this.onMetricsUpdated = onMetricsUpdated || (() => {
    });
    console.log(`DocumentMetricsDisplay \u521D\u59CB\u5316: ${file.basename}`);
  }
  render() {
    const metricsContent = this.container.createEl("div", { cls: "metrics-content" });
    const isRoamingDoc = this.plugin.settings.roamingDocs.includes(this.file.path);
    console.log(`\u6E32\u67D3\u6587\u6863\u6307\u6807: ${this.file.basename}, \u662F\u5426\u6F2B\u6E38: ${isRoamingDoc}`);
    if (isRoamingDoc) {
      this.createCustomMetricsSection(metricsContent);
      this.createPrioritySection(metricsContent);
      this.createVisitStatsSection(metricsContent);
    } else {
      this.createNonRoamingPrompt(metricsContent);
    }
    return metricsContent;
  }
  createNonRoamingPrompt(metricsContent) {
    const promptSection = metricsContent.createEl("div", { cls: "non-roaming-prompt" });
    const header = promptSection.createEl("div", { cls: "prompt-header" });
    header.createEl("span", { cls: "prompt-icon", text: "\u{1F4CB}" });
    header.createEl("h3", { cls: "prompt-title", text: "\u6B64\u6587\u6863\u5C1A\u672A\u52A0\u5165\u6F2B\u6E38\u5217\u8868" });
    const description = promptSection.createEl("p", { cls: "prompt-description" });
    description.textContent = "\u52A0\u5165\u6F2B\u6E38\u5217\u8868\u540E\uFF0C\u60A8\u5C31\u53EF\u4EE5\u4E3A\u6B64\u6587\u6863\u8BBE\u7F6E\u81EA\u5B9A\u4E49\u6307\u6807\u3001\u8C03\u6574\u4F18\u5148\u7EA7\uFF0C\u5E76\u4EAB\u53D7\u667A\u80FD\u63A8\u8350\u529F\u80FD\u3002";
    const benefitsList = promptSection.createEl("ul", { cls: "benefits-list" });
    const benefits = [
      "\u{1F4CA} \u8BBE\u7F6E\u81EA\u5B9A\u4E49\u6307\u6807\u8BC4\u5206",
      "\u{1F3AF} \u8C03\u6574\u6587\u6863\u4F18\u5148\u7EA7",
      "\u{1F9E0} \u83B7\u5F97\u667A\u80FD\u63A8\u8350",
      "\u{1F4C8} \u53C2\u4E0E\u6392\u884C\u699C\u7EDF\u8BA1"
    ];
    benefits.forEach((benefit) => {
      const li = benefitsList.createEl("li");
      li.textContent = benefit;
    });
    const actionSection = promptSection.createEl("div", { cls: "prompt-action" });
    const addButton = actionSection.createEl("button", {
      cls: "add-to-roaming-btn",
      text: "+ \u52A0\u5165\u6F2B\u6E38\u5217\u8868"
    });
    addButton.onclick = async () => {
      try {
        if (this.file.extension !== "md") {
          new import_obsidian2.Notice(`\u53EA\u80FD\u6DFB\u52A0Markdown\u6587\u6863\u5230\u6F2B\u6E38\u5217\u8868`);
          return;
        }
        if (!this.plugin.settings.roamingDocs.includes(this.file.path)) {
          this.plugin.settings.roamingDocs.push(this.file.path);
          const fileService = this.plugin.fileManagementService;
          const defaultMetrics = fileService.createDefaultMetricsForFile(this.file);
          await this.plugin.updateDocumentMetrics(this.file, defaultMetrics);
          await this.plugin.saveSettings();
          new import_obsidian2.Notice(`\u2705 \u5DF2\u5C06 "${this.file.basename}" \u52A0\u5165\u6F2B\u6E38\u5217\u8868`);
          this.container.empty();
          this.render();
          this.onMetricsUpdated();
        }
      } catch (error) {
        console.error("\u52A0\u5165\u6F2B\u6E38\u5931\u8D25:", error);
        new import_obsidian2.Notice("\u52A0\u5165\u6F2B\u6E38\u5931\u8D25");
      }
    };
  }
  async updateDocumentMetricsRealTime(file, realTimeMetrics) {
    try {
      this.plugin.settings.documentMetrics[file.path] = {
        ...realTimeMetrics,
        lastVisited: Date.now()
      };
    } catch (error) {
      console.warn("\u5B9E\u65F6\u6307\u6807\u66F4\u65B0\u5931\u8D25:", error);
    }
  }
  updateMetricValueColor(valueElement, value) {
    if (value >= 8) {
      valueElement.style.color = "#dc3545";
    } else if (value >= 6) {
      valueElement.style.color = "#fd7e14";
    } else if (value >= 4) {
      valueElement.style.color = "#ffc107";
    } else {
      valueElement.style.color = "#28a745";
    }
  }
  updatePriorityDisplay(metricsContent) {
    const priorityValue = metricsContent.querySelector(".priority-value");
    if (priorityValue) {
      const calculatedPriority = this.calculatePriority(this.metrics);
      priorityValue.textContent = calculatedPriority.toFixed(2);
      priorityValue.style.color = SharedUtils.getPriorityColor(calculatedPriority);
    }
    const breakdown = metricsContent.querySelector(".breakdown-list");
    if (breakdown) {
      breakdown.empty();
      this.createWeightBreakdownContent(breakdown);
    }
  }
  createWeightBreakdownContent(breakdown) {
    const customMetrics = this.plugin.settings.customMetrics;
    const weights = this.plugin.settings.metricWeights;
    for (const metric of customMetrics) {
      const metricValue = this.metrics[metric.id] || 0;
      const metricWeight = weights[metric.id] || metric.weight;
      const normalizedWeight = metricWeight / 100;
      const score = metricValue * normalizedWeight;
      const breakdownItem = breakdown.createEl("div", { cls: "breakdown-item" });
      breakdownItem.createEl("span", {
        cls: "breakdown-label",
        text: `${metric.name} (${metricWeight}%):`
      });
      breakdownItem.createEl("span", {
        cls: "breakdown-score",
        text: `${metricValue} \xD7 ${normalizedWeight.toFixed(2)} = ${score.toFixed(2)}`
      });
    }
    const totalScore = this.calculatePriority(this.metrics);
    const totalItem = breakdown.createEl("div", { cls: "breakdown-item total" });
    totalItem.createEl("span", { cls: "breakdown-label", text: "\u603B\u5206:" });
    totalItem.createEl("span", { cls: "breakdown-score total-score", text: totalScore.toFixed(2) });
  }
  createPrioritySection(metricsContent) {
    const prioritySection = metricsContent.createEl("div", { cls: "priority-section" });
    prioritySection.createEl("div", { cls: "priority-label", text: "\u4F18\u5148\u7EA7" });
    const calculatedPriority = this.calculatePriority(this.metrics);
    const priorityValue = prioritySection.createEl("div", {
      cls: "priority-value",
      text: calculatedPriority.toFixed(2)
    });
    const breakdown = metricsContent.createEl("div", { cls: "weight-breakdown" });
    this.createWeightBreakdown(breakdown);
  }
  createCustomMetricsSection(metricsContent) {
    const customMetricsSection = metricsContent.createEl("div", { cls: "custom-metrics-section" });
    customMetricsSection.createEl("h4", { text: "\u81EA\u5B9A\u4E49\u6307\u6807" });
    const metricsList = customMetricsSection.createEl("div", { cls: "metrics-list" });
    for (const metric of this.plugin.settings.customMetrics) {
      const metricItem = metricsList.createEl("div", { cls: "metric-item" });
      const labelRow = metricItem.createEl("div", { cls: "metric-label-row" });
      const label = labelRow.createEl("span", { cls: "metric-label", text: `${metric.name} (${metric.weight}%):` });
      const valueDisplay = labelRow.createEl("span", {
        cls: "metric-value",
        text: (this.metrics[metric.id] || 5).toFixed(1)
      });
      const metricValue = this.metrics[metric.id] || 5;
      this.updateMetricValueColor(valueDisplay, metricValue);
      const slider = metricItem.createEl("input", {
        type: "range",
        cls: "metric-slider",
        attr: {
          min: "0",
          max: "10",
          step: "0.5",
          "data-metric-id": metric.id
        }
      });
      slider.value = metricValue.toString();
      let updateTimeout = null;
      const debouncedUpdate = async (newValue) => {
        if (updateTimeout) {
          clearTimeout(updateTimeout);
        }
        updateTimeout = setTimeout(async () => {
          try {
            this.metrics[metric.id] = newValue;
            await this.updateDocumentMetricsRealTime(this.file, this.metrics);
            this.updatePriorityDisplay(metricsContent);
            this.onMetricsUpdated();
          } catch (error) {
            console.warn("Failed to update metric:", error);
          }
        }, 300);
      };
      slider.addEventListener("input", () => {
        const newValue = parseFloat(slider.value);
        valueDisplay.textContent = newValue.toFixed(1);
        this.updateMetricValueColor(valueDisplay, newValue);
        debouncedUpdate(newValue);
      });
      slider.addEventListener("change", async () => {
        const newValue = parseFloat(slider.value);
        valueDisplay.textContent = newValue.toFixed(1);
        this.updateMetricValueColor(valueDisplay, newValue);
        this.metrics[metric.id] = newValue;
        await this.updateDocumentMetricsRealTime(this.file, this.metrics);
        this.updatePriorityDisplay(metricsContent);
        this.onMetricsUpdated();
      });
      slider.addEventListener("keydown", (e) => {
        const currentValue = parseFloat(slider.value);
        let newValue = currentValue;
        switch (e.key) {
          case "ArrowLeft":
          case "ArrowDown":
            newValue = Math.max(0, currentValue - 0.5);
            break;
          case "ArrowRight":
          case "ArrowUp":
            newValue = Math.min(10, currentValue + 0.5);
            break;
          case "Home":
            newValue = 0;
            break;
          case "End":
            newValue = 10;
            break;
          default:
            return;
        }
        e.preventDefault();
        slider.value = newValue.toString();
        valueDisplay.textContent = newValue.toFixed(1);
        this.updateMetricValueColor(valueDisplay, newValue);
        debouncedUpdate(newValue);
      });
      const updateSliderBackground = () => {
        const value = parseFloat(slider.value);
        const percentage = value / 10 * 100;
        slider.style.background = `linear-gradient(to right, var(--interactive-accent) 0%, var(--interactive-accent) ${percentage}%, var(--background-modifier-border) ${percentage}%, var(--background-modifier-border) 100%)`;
      };
      slider.addEventListener("input", updateSliderBackground);
      updateSliderBackground();
    }
  }
  createVisitStatsSection(metricsContent) {
    const visitSection = metricsContent.createEl("div", { cls: "visit-section" });
    visitSection.createEl("h4", { text: "\u8BBF\u95EE\u7EDF\u8BA1" });
    const visitStats = visitSection.createEl("div", { cls: "visit-stats" });
    const visitCount = visitStats.createEl("div", { cls: "visit-stat" });
    visitCount.createEl("span", { cls: "stat-label", text: "\u8BBF\u95EE\u6B21\u6570: " });
    visitCount.createEl("span", { cls: "stat-value", text: this.metrics.visitCount.toString() });
    const lastVisited = visitStats.createEl("div", { cls: "visit-stat" });
    lastVisited.createEl("span", { cls: "stat-label", text: "\u6700\u540E\u8BBF\u95EE: " });
    if (this.metrics.lastVisited) {
      const lastVisitedDate = new Date(this.metrics.lastVisited);
      lastVisited.createEl("span", {
        cls: "stat-value",
        text: lastVisitedDate.toLocaleString()
      });
    } else {
      lastVisited.createEl("span", { cls: "stat-value", text: "\u4ECE\u672A\u8BBF\u95EE" });
    }
  }
  createWeightBreakdown(breakdown) {
    breakdown.createEl("h5", { text: "\u6743\u91CD\u5206\u6790" });
    const breakdownList = breakdown.createEl("div", { cls: "breakdown-list" });
    this.createWeightBreakdownContent(breakdownList);
  }
  calculatePriority(metrics) {
    const customMetrics = this.plugin.settings.customMetrics;
    const weights = this.plugin.settings.metricWeights;
    let totalScore = 0;
    let totalWeight = 0;
    for (const metric of customMetrics) {
      const metricValue = metrics[metric.id] || 5;
      const metricWeight = weights[metric.id] || metric.weight;
      const normalizedWeight = metricWeight / 100;
      const score = metricValue * normalizedWeight;
      totalScore += score;
      totalWeight += normalizedWeight;
    }
    return totalWeight > 0 ? totalScore / totalWeight * 10 : 0;
  }
  /**
   * 更新指标数据和文件
   */
  updateMetrics(fileOrMetrics, metrics) {
    if (fileOrMetrics instanceof import_obsidian2.TFile && metrics) {
      console.log(`DocumentMetricsDisplay \u66F4\u65B0: ${this.file.basename} -> ${fileOrMetrics.basename}`);
      this.file = fileOrMetrics;
      this.metrics = metrics;
    } else if (fileOrMetrics && !metrics) {
      console.log(`DocumentMetricsDisplay \u66F4\u65B0\u6307\u6807: ${this.file.basename}`);
      this.metrics = fileOrMetrics;
    }
    this.container.empty();
    this.render();
  }
};

// src/views/components/NavigationTabs.ts
var NavigationTabs = class {
  constructor(container, onTabChange, initialTab = "metrics") {
    this.tabSlider = null;
    this.tabButtons = [];
    this.currentActiveTab = "";
    this.currentTabIndex = 0;
    this.container = container;
    this.onTabChange = onTabChange;
    this.currentActiveTab = initialTab;
    this.create();
  }
  create() {
    const navSection = this.container.createEl("div", { cls: "sliding-navigation" });
    const tabContainer = navSection.createEl("div", { cls: "tabs-wrapper" });
    this.tabSlider = tabContainer.createEl("div", { cls: "tab-slider" });
    const tabs = [
      { id: "metrics", label: "\u6587\u6863\u6307\u6807", icon: "\u{1F4CA}" },
      { id: "recommendations", label: "\u667A\u80FD\u63A8\u8350", icon: "\u{1F9E0}" },
      { id: "ranking", label: "\u6F2B\u6E38\u6392\u884C", icon: "\u{1F3C6}" }
    ];
    this.tabButtons = [];
    tabs.forEach((tab, index) => {
      const tabBtn = tabContainer.createEl("button", {
        cls: "tab-btn",
        text: `${tab.icon} ${tab.label}`
      });
      tabBtn.setAttribute("data-target", tab.id);
      tabBtn.onclick = () => this.switchToTab(tab.id, index);
      if (tab.id === this.currentActiveTab) {
        tabBtn.addClass("active");
        this.currentTabIndex = index;
      }
      this.tabButtons.push(tabBtn);
    });
    this.updateTabSlider();
  }
  switchToTab(tabId, index) {
    if (this.currentActiveTab === tabId)
      return;
    this.tabButtons.forEach((btn, i) => {
      btn.toggleClass("active", i === index);
    });
    this.currentActiveTab = tabId;
    this.currentTabIndex = index;
    this.updateTabSlider();
    this.onTabChange(tabId, index);
  }
  updateTabSlider() {
    if (!this.tabSlider || !this.tabButtons[this.currentTabIndex])
      return;
    const activeTab = this.tabButtons[this.currentTabIndex];
    const tabRect = activeTab.getBoundingClientRect();
    const containerRect = activeTab.parentElement.getBoundingClientRect();
    this.tabSlider.style.width = `${tabRect.width}px`;
    this.tabSlider.style.left = `${tabRect.left - containerRect.left}px`;
  }
  /**
   * 获取当前激活的标签ID
   */
  getCurrentTab() {
    return this.currentActiveTab;
  }
  /**
   * 获取当前激活的标签索引
   */
  getCurrentTabIndex() {
    return this.currentTabIndex;
  }
  /**
   * 切换到指定标签
   */
  setActiveTab(tabId) {
    const tabIndex = this.tabButtons.findIndex((btn) => btn.getAttribute("data-target") === tabId);
    if (tabIndex !== -1) {
      this.switchToTab(tabId, tabIndex);
    }
  }
};

// src/views/components/RankingList.ts
var RankingList = class {
  constructor(container, plugin, callbacks) {
    this.currentRankingType = "priority";
    this.container = container;
    this.plugin = plugin;
    this.onOpenDocument = callbacks.onOpenDocument;
    this.onEditMetrics = callbacks.onEditMetrics;
  }
  render() {
    this.container.empty();
    const rankingSection = this.container.createEl("div", { cls: "ranking-section" });
    const headerContainer = rankingSection.createEl("div", { cls: "ranking-header" });
    const title = headerContainer.createEl("h3", { text: "\u{1F3C6} \u6587\u6863\u6392\u884C\u699C" });
    const toggleContainer = headerContainer.createEl("div", { cls: "ranking-toggle" });
    const priorityBtn = toggleContainer.createEl("button", {
      cls: `toggle-btn ${this.currentRankingType === "priority" ? "active" : ""}`,
      text: "\u4F18\u5148\u7EA7\u6392\u884C"
    });
    priorityBtn.onclick = () => this.switchRankingType("priority");
    const visitsBtn = toggleContainer.createEl("button", {
      cls: `toggle-btn ${this.currentRankingType === "visits" ? "active" : ""}`,
      text: "\u8BBF\u95EE\u6B21\u6570\u6392\u884C"
    });
    visitsBtn.onclick = () => this.switchRankingType("visits");
    const rankingList = rankingSection.createEl("div", { cls: "ranking-list" });
    const rankedDocuments = this.currentRankingType === "priority" ? this.getDocumentsByPriority() : this.getDocumentsByVisits();
    if (rankedDocuments.length === 0) {
      rankingList.createEl("p", {
        text: "\u6682\u65E0\u6F2B\u6E38\u6587\u6863\uFF0C\u8BF7\u5148\u6DFB\u52A0\u6587\u6863\u5230\u6F2B\u6E38\u5217\u8868",
        cls: "empty-message"
      });
      return;
    }
    const topDocuments = rankedDocuments.slice(0, 10);
    topDocuments.forEach(({ file, score, metrics }, index) => {
      const rankingItem = this.createRankingItem(file, score, metrics, index + 1);
      rankingList.appendChild(rankingItem);
    });
    const refreshBtn = rankingSection.createEl("button", {
      cls: "refresh-ranking-btn",
      text: "\u{1F504} \u5237\u65B0\u6392\u884C\u699C"
    });
    refreshBtn.onclick = () => this.render();
  }
  getDocumentsByPriority() {
    const files = this.plugin.getValidRoamingFiles();
    const documentsWithPriority = files.map((file) => {
      const metrics = this.plugin.getDocumentMetrics(file);
      const priority = SharedUtils.calculatePriority(metrics, this.plugin.settings.metricWeights, this.plugin.settings.customMetrics);
      return { file, score: priority, metrics };
    });
    return documentsWithPriority.sort((a, b) => b.score - a.score);
  }
  getDocumentsByVisits() {
    const files = this.plugin.getValidRoamingFiles();
    const documentsWithVisits = files.map((file) => {
      const metrics = this.plugin.getDocumentMetrics(file);
      const visitCount = metrics.visitCount || 0;
      return { file, score: visitCount, metrics };
    });
    return documentsWithVisits.sort((a, b) => b.score - a.score);
  }
  switchRankingType(type) {
    this.currentRankingType = type;
    this.render();
  }
  createRankingItem(file, score, metrics, rank) {
    const item = document.createElement("div");
    item.className = "ranking-item";
    const rankBadge = item.createEl("span", { cls: "rank-badge" });
    rankBadge.textContent = rank.toString();
    if (rank === 1) {
      rankBadge.addClass("gold");
    } else if (rank === 2) {
      rankBadge.addClass("silver");
    } else if (rank === 3) {
      rankBadge.addClass("bronze");
    }
    const fileInfo = item.createEl("div", { cls: "file-info" });
    const fileName = fileInfo.createEl("div", { cls: "file-name" });
    fileName.textContent = file.basename;
    fileName.title = file.path;
    const filePath = fileInfo.createEl("div", { cls: "file-path" });
    filePath.textContent = file.path;
    const scoreInfo = item.createEl("div", { cls: "score-info" });
    const mainScoreEl = scoreInfo.createEl("span", { cls: "main-score" });
    if (this.currentRankingType === "priority") {
      mainScoreEl.textContent = `\u4F18\u5148\u7EA7: ${score.toFixed(1)}`;
      mainScoreEl.style.color = SharedUtils.getPriorityColor(score);
    } else {
      mainScoreEl.textContent = `\u8BBF\u95EE\u6B21\u6570: ${score}\u6B21`;
      mainScoreEl.style.color = this.getVisitCountColor(score);
    }
    const actions = item.createEl("div", { cls: "actions" });
    const openBtn = actions.createEl("button", {
      cls: "open-btn",
      text: "\u{1F4D6} \u6253\u5F00"
    });
    openBtn.title = "\u6253\u5F00\u6587\u6863";
    openBtn.onclick = () => this.onOpenDocument(file);
    return item;
  }
  getVisitCountColor(visits) {
    if (visits >= 10) {
      return "#dc3545";
    } else if (visits >= 5) {
      return "#fd7e14";
    } else if (visits >= 2) {
      return "#ffc107";
    } else {
      return "#28a745";
    }
  }
  /**
   * 刷新排行榜数据
   */
  refresh() {
    this.render();
  }
};

// src/views/components/RecommendationList.ts
var import_obsidian3 = require("obsidian");
var RecommendationList = class {
  constructor(container, plugin, callbacks) {
    this.cachedRecommendations = [];
    this.container = container;
    this.plugin = plugin;
    this.onOpenDocument = callbacks.onOpenDocument;
    this.onEditMetrics = callbacks.onEditMetrics;
  }
  render(recommendations) {
    this.container.empty();
    const recommendationsSection = this.container.createEl("div", { cls: "recommendations-section" });
    recommendationsSection.createEl("h3", { text: "\u{1F9E0} \u667A\u80FD\u63A8\u8350" });
    if (recommendations.length === 0) {
      recommendationsSection.createEl("p", {
        text: "\u6682\u65E0\u63A8\u8350\u6587\u6863\uFF0C\u8BF7\u6DFB\u52A0\u66F4\u591A\u6587\u6863\u5230\u6F2B\u6E38\u5217\u8868",
        cls: "empty-message"
      });
      return;
    }
    const recommendationsList = recommendationsSection.createEl("div", { cls: "recommendations-list" });
    recommendations.forEach((file, index) => {
      const recItem = this.createRecommendationItem(file, index);
      recommendationsList.appendChild(recItem);
    });
    const buttonContainer = recommendationsSection.createEl("div", { cls: "recommendation-buttons" });
    const refreshBtn = buttonContainer.createEl("button", {
      cls: "refresh-recommendations-btn",
      text: "\u{1F504} \u5237\u65B0\u63A8\u8350"
    });
    refreshBtn.onclick = () => this.refresh();
    const smartJumpBtn = buttonContainer.createEl("button", {
      cls: "smart-jump-btn",
      text: "\u{1F9E0} \u8DF3\u8F6C\u81F3\u6700\u9AD8\u76F8\u4F3C\u5EA6"
    });
    smartJumpBtn.onclick = async () => {
      try {
        const recommendations2 = await this.plugin.recommendationService.getRecommendations();
        if (recommendations2.length === 0) {
          new import_obsidian3.Notice("\u6682\u65E0\u63A8\u8350\u6587\u6863");
          return;
        }
        const topRecommendation = recommendations2[0];
        const similarity = (topRecommendation.score * 100).toFixed(1);
        await this.onOpenDocument(topRecommendation.file);
        new import_obsidian3.Notice(`\u{1F9E0} \u667A\u80FD\u63A8\u8350\uFF1A${topRecommendation.file.basename} (\u76F8\u4F3C\u5EA6: ${similarity}%)`);
      } catch (error) {
        console.error("\u667A\u80FD\u8DF3\u8F6C\u5931\u8D25:", error);
        new import_obsidian3.Notice("\u667A\u80FD\u8DF3\u8F6C\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5");
      }
    };
  }
  renderWithScores(recommendations) {
    this.container.empty();
    this.cachedRecommendations = recommendations;
    const recommendationsSection = this.container.createEl("div", { cls: "recommendations-section" });
    recommendationsSection.createEl("h3", { text: "\u{1F9E0} \u667A\u80FD\u63A8\u8350" });
    if (recommendations.length === 0) {
      recommendationsSection.createEl("p", {
        text: "\u6682\u65E0\u63A8\u8350\u6587\u6863\uFF0C\u8BF7\u6DFB\u52A0\u66F4\u591A\u6587\u6863\u5230\u6F2B\u6E38\u5217\u8868",
        cls: "empty-message"
      });
      return;
    }
    const recommendationsList = recommendationsSection.createEl("div", { cls: "recommendations-list" });
    recommendations.forEach((rec, index) => {
      const recItem = this.createRecommendationItemWithScore(rec, index);
      recommendationsList.appendChild(recItem);
    });
    const buttonContainer = recommendationsSection.createEl("div", { cls: "recommendation-buttons" });
    const refreshBtn = buttonContainer.createEl("button", {
      cls: "refresh-recommendations-btn",
      text: "\u{1F504} \u5237\u65B0\u63A8\u8350"
    });
    refreshBtn.onclick = () => this.refresh();
    const smartJumpBtn = buttonContainer.createEl("button", {
      cls: "smart-jump-btn",
      text: "\u{1F9E0} \u8DF3\u8F6C\u81F3\u6700\u9AD8\u76F8\u4F3C\u5EA6"
    });
    smartJumpBtn.onclick = async () => {
      try {
        const recommendations2 = await this.plugin.recommendationService.getRecommendations();
        if (recommendations2.length === 0) {
          new import_obsidian3.Notice("\u6682\u65E0\u63A8\u8350\u6587\u6863");
          return;
        }
        const topRecommendation = recommendations2[0];
        const similarity = (topRecommendation.score * 100).toFixed(1);
        await this.onOpenDocument(topRecommendation.file);
        new import_obsidian3.Notice(`\u{1F9E0} \u667A\u80FD\u63A8\u8350\uFF1A${topRecommendation.file.basename} (\u76F8\u4F3C\u5EA6: ${similarity}%)`);
      } catch (error) {
        console.error("\u667A\u80FD\u8DF3\u8F6C\u5931\u8D25:", error);
        new import_obsidian3.Notice("\u667A\u80FD\u8DF3\u8F6C\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5");
      }
    };
  }
  createRecommendationItem(file, index) {
    const recItem = document.createElement("div");
    recItem.className = "recommendation-item";
    recItem.setAttribute("data-file-path", file.path);
    const recNumber = recItem.createEl("span", { cls: "rec-number" });
    recNumber.textContent = (index + 1).toString();
    const fileInfo = recItem.createEl("div", { cls: "file-info" });
    const fileName = fileInfo.createEl("div", { cls: "file-name" });
    fileName.textContent = file.basename;
    fileName.title = file.path;
    const metricsInfo = recItem.createEl("div", { cls: "metrics-info" });
    const metrics = this.plugin.getDocumentMetrics(file);
    const calculatedPriority = SharedUtils.calculatePriority(metrics, this.plugin.settings.metricWeights, this.plugin.settings.customMetrics);
    const priorityEl = metricsInfo.createEl("span", { cls: "priority" });
    priorityEl.textContent = `Priority: ${calculatedPriority.toFixed(1)}`;
    priorityEl.style.color = SharedUtils.getPriorityColor(calculatedPriority);
    for (const metric of this.plugin.settings.customMetrics.slice(0, 2)) {
      const metricEl = metricsInfo.createEl("span", { cls: "metric" });
      const metricValue = metrics[metric.id] || 0;
      metricEl.textContent = `${metric.name}: ${metricValue.toFixed(1)}`;
    }
    const visitEl = metricsInfo.createEl("span", { cls: "visit-count" });
    visitEl.textContent = `\u8BBF\u95EE: ${metrics.visitCount || 0}\u6B21`;
    const actions = recItem.createEl("div", { cls: "quick-actions" });
    const openBtn = actions.createEl("button", { text: "\u6253\u5F00" });
    openBtn.onclick = () => this.onOpenDocument(file);
    return recItem;
  }
  createRecommendationItemWithScore(rec, index) {
    const recItem = document.createElement("div");
    recItem.className = "recommendation-item";
    recItem.setAttribute("data-file-path", rec.file.path);
    const recNumber = recItem.createEl("span", { cls: "rec-number" });
    recNumber.textContent = (index + 1).toString();
    const fileInfo = recItem.createEl("div", { cls: "file-info" });
    const fileName = fileInfo.createEl("div", { cls: "file-name" });
    fileName.textContent = rec.file.basename;
    fileName.title = rec.file.path;
    const similarityInfo = recItem.createEl("div", { cls: "similarity-info" });
    const similarityEl = similarityInfo.createEl("span", { cls: "similarity-score-large" });
    similarityEl.textContent = `\u76F8\u4F3C\u5EA6: ${(rec.score * 100).toFixed(1)}%`;
    similarityEl.style.color = this.getSimilarityColor(rec.score);
    const actions = recItem.createEl("div", { cls: "quick-actions" });
    const openBtn = actions.createEl("button", { text: "\u6253\u5F00" });
    openBtn.onclick = () => this.onOpenDocument(rec.file);
    return recItem;
  }
  getSimilarityColor(score) {
    if (score >= 0.8) {
      return "#dc3545";
    } else if (score >= 0.6) {
      return "#fd7e14";
    } else if (score >= 0.4) {
      return "#ffc107";
    } else {
      return "#28a745";
    }
  }
  /**
   * 刷新推荐列表
   */
  async refresh() {
    try {
      const recommendations = await this.plugin.recommendationService.getRecommendations();
      this.renderWithScores(recommendations);
    } catch (error) {
      console.error("\u5237\u65B0\u63A8\u8350\u5931\u8D25:", error);
    }
  }
  /**
   * 更新特定文件项的显示
   */
  updateFileItem(filePath) {
    const fileItem = this.container.querySelector(`[data-file-path="${filePath}"]`);
    if (fileItem) {
      const file = this.plugin.app.vault.getAbstractFileByPath(filePath);
      if (file) {
        const metrics = this.plugin.getDocumentMetrics(file);
        const priorityEl = fileItem.querySelector(".priority");
        if (priorityEl) {
          const calculatedPriority = SharedUtils.calculatePriority(metrics, this.plugin.settings.metricWeights, this.plugin.settings.customMetrics);
          priorityEl.textContent = `Priority: ${calculatedPriority.toFixed(1)}`;
          priorityEl.setAttribute("style", `color: ${SharedUtils.getPriorityColor(calculatedPriority)}`);
        }
      }
    }
  }
};

// src/views/IncrementalReadingView.ts
var VIEW_TYPE_INCREMENTAL_READING = "incremental-reading-view";
var IncrementalReadingView = class extends import_obsidian4.ItemView {
  constructor(leaf, plugin) {
    super(leaf);
    this.currentFile = null;
    this.currentMetrics = null;
    // 状态元素
    this.statusText = null;
    // 组件实例
    this.actionBar = null;
    this.documentMetricsDisplay = null;
    this.navigationTabs = null;
    this.rankingList = null;
    this.recommendationList = null;
    // 视图状态
    this.currentActiveTab = "metrics";
    this.plugin = plugin;
  }
  getViewType() {
    return VIEW_TYPE_INCREMENTAL_READING;
  }
  getDisplayText() {
    return "Incremental Reading";
  }
  getIcon() {
    return "book-open";
  }
  async onOpen() {
    this.createView();
  }
  async onClose() {
    this.cleanup();
  }
  createView() {
    const container = this.containerEl.children[1];
    container.empty();
    container.addClass("plugin-container");
    this.createHeroSection(container);
    this.createSlidingNavigation(container);
    this.createContentArea(container);
    this.addStyles();
    this.registerEvent(
      this.app.workspace.on("file-open", (file) => {
        this.onFileOpen(file);
      })
    );
    this.refreshData();
    setTimeout(() => {
      this.switchToTab("metrics", 0);
    }, 100);
  }
  createHeroSection(container) {
    const heroSection = container.createEl("div", { cls: "hero-section" });
    heroSection.createEl("h1", { cls: "main-title", text: "\u6F2B\u6E38\u5F0F\u6E10\u8FDB\u9605\u8BFB" });
    const subtitle = heroSection.createEl("p", { cls: "poetic-subtitle" });
    subtitle.innerHTML = '"\u5C55\u5377\u4E43\u65E0\u8A00\u7684\u60C5\u610F\uFF1A\u4EE5<span class="chance">\u7B49\u5F85\u6F2B\u6E38...</span>\u7684\u673A\u9047\uFF0C<br>\u7A7F\u8D8A\u661F\u8FB0\u9047\u89C1\u4F60\uFF0C\u4E09\u79CB\u971C\u96EA\u5370\u9A6C\u8E44\u3002"';
    const docCount = this.getVisitedDocumentCount();
    this.statusText = heroSection.createEl("div", { cls: "status-text" });
    this.statusText.textContent = `${docCount} \u7BC7\u6F2B\u6E38\u6587\u6863${docCount === 0 ? " (\u65E0\u6F2B\u6E38\u6587\u6863)" : ""}`;
    this.actionBar = new ActionBar(heroSection, this.plugin, {
      onContinueReading: () => this.continueReading(),
      onGetSmartRecommendations: () => this.getSmartRecommendations(),
      onRefreshData: () => this.refreshData(),
      onRandomRoaming: () => this.randomRoaming(),
      onAddCurrentToRoaming: () => this.addCurrentToRoaming()
    });
  }
  createSlidingNavigation(container) {
    this.navigationTabs = new NavigationTabs(
      container,
      (tabId, index) => this.switchToTab(tabId, index),
      "metrics"
    );
  }
  createContentArea(container) {
    const content = container.createEl("div", { cls: "content-area" });
    this.createMetricsSection(content);
    this.createRecommendationsSection(content);
    this.createRankingSection(content);
    this.hideAllSections();
  }
  createMetricsSection(container) {
    const metricsSection = container.createEl("div", { cls: "metrics-section", attr: { "data-section": "metrics" } });
    const activeFile = this.app.workspace.getActiveFile();
    if (activeFile) {
      const metrics = this.plugin.getDocumentMetrics(activeFile);
      this.documentMetricsDisplay = new DocumentMetricsDisplay(
        metricsSection,
        this.plugin,
        activeFile,
        metrics,
        () => this.refreshData()
        // 当指标更新时刷新数据
      );
      this.documentMetricsDisplay.render();
    } else {
      metricsSection.createEl("p", { text: "\u8BF7\u5148\u6253\u5F00\u4E00\u4E2AMarkdown\u6587\u6863", cls: "empty-message" });
    }
  }
  createRecommendationsSection(container) {
    const recommendationsSection = container.createEl("div", { cls: "recommendations-section", attr: { "data-section": "recommendations" } });
    this.recommendationList = new RecommendationList(recommendationsSection, this.plugin, {
      onOpenDocument: (file) => this.openDocument(file),
      onEditMetrics: (file, metrics) => {
      }
      // 空实现，保留接口兼容性
    });
  }
  createRankingSection(container) {
    const rankingSection = container.createEl("div", { cls: "ranking-section", attr: { "data-section": "ranking" } });
    this.rankingList = new RankingList(rankingSection, this.plugin, {
      onOpenDocument: (file) => this.openDocument(file),
      onEditMetrics: (file, metrics) => {
      }
      // 空实现，保留接口兼容性
    });
  }
  async switchToTab(tabId, index) {
    var _a;
    this.currentActiveTab = tabId;
    this.hideAllSections();
    this.showSection(tabId);
    (_a = this.navigationTabs) == null ? void 0 : _a.setActiveTab(tabId);
    switch (tabId) {
      case "metrics":
        this.updateMetricsSection();
        break;
      case "recommendations":
        await this.updateRecommendationsSection();
        break;
      case "ranking":
        this.updateRankingSection();
        break;
    }
  }
  hideAllSections() {
    const sections = this.containerEl.querySelectorAll("[data-section]");
    sections.forEach((section) => {
      section.style.display = "none";
    });
  }
  showSection(sectionId) {
    const section = this.containerEl.querySelector(`[data-section="${sectionId}"]`);
    if (section) {
      section.style.display = "block";
    }
  }
  updateMetricsSection() {
    const activeFile = this.app.workspace.getActiveFile();
    if (activeFile && this.documentMetricsDisplay) {
      const metrics = this.plugin.getDocumentMetrics(activeFile);
      this.documentMetricsDisplay.updateMetrics(activeFile, metrics);
    }
  }
  async updateRecommendationsSection() {
    if (this.recommendationList) {
      try {
        const recommendations = await this.plugin.recommendationService.getRecommendations();
        this.recommendationList.renderWithScores(recommendations);
      } catch (error) {
        console.error("\u66F4\u65B0\u63A8\u8350\u90E8\u5206\u5931\u8D25:", error);
        const recommendations = this.plugin.getRecommendedDocuments(10);
        this.recommendationList.render(recommendations);
      }
    }
  }
  updateRankingSection() {
    if (this.rankingList) {
      this.rankingList.refresh();
    }
  }
  // 业务逻辑方法
  async onFileOpen(file) {
    var _a, _b;
    if (!file)
      return;
    try {
      console.log(`\u6587\u4EF6\u5207\u6362\u5230: ${file.path} (\u5F53\u524D\u6807\u7B7E: ${this.currentActiveTab})`);
      this.currentFile = file;
      this.currentMetrics = this.plugin.getDocumentMetrics(file);
      await this.plugin.updateDocumentMetrics(file, {
        lastVisited: Date.now(),
        visitCount: (((_a = this.currentMetrics) == null ? void 0 : _a.visitCount) || 0) + 1
      });
      if (this.currentActiveTab === "metrics") {
        this.updateMetricsSection();
      }
      (_b = this.actionBar) == null ? void 0 : _b.updateButtonStates();
    } catch (error) {
      console.error("\u6587\u4EF6\u5207\u6362\u5904\u7406\u5931\u8D25:", error);
      new import_obsidian4.Notice("\u6587\u4EF6\u5207\u6362\u65F6\u51FA\u73B0\u9519\u8BEF");
    }
  }
  async continueReading() {
    var _a;
    try {
      const validRoamingFiles = this.plugin.getValidRoamingFiles();
      if (validRoamingFiles.length === 0) {
        new import_obsidian4.Notice("\u6682\u65E0\u6F2B\u6E38\u6587\u6863\uFF0C\u8BF7\u5148\u6DFB\u52A0\u6587\u6863\u5230\u6F2B\u6E38\u5217\u8868");
        return;
      }
      const weightedFiles = validRoamingFiles.map((file) => {
        const metrics = this.plugin.getDocumentMetrics(file);
        const priority = this.calculatePriority(metrics);
        return { file, weight: Math.max(0.1, priority) };
      });
      const totalWeight = weightedFiles.reduce((sum, item) => sum + item.weight, 0);
      let random = Math.random() * totalWeight;
      let selectedFile = null;
      for (const { file, weight } of weightedFiles) {
        random -= weight;
        if (random <= 0) {
          selectedFile = file;
          break;
        }
      }
      if (selectedFile) {
        await this.openDocument(selectedFile);
        const selectedWeight = ((_a = weightedFiles.find((item) => item.file.path === selectedFile.path)) == null ? void 0 : _a.weight) || 0.1;
        const selectionProbability = selectedWeight / totalWeight * 100;
        new import_obsidian4.Notice(`\u5DF2\u9009\u62E9\uFF1A${selectedFile.basename} (\u9009\u62E9\u6982\u7387: ${selectionProbability.toFixed(1)}%)`);
      }
    } catch (error) {
      console.error("\u7EE7\u7EED\u6F2B\u6E38\u5931\u8D25:", error);
      new import_obsidian4.Notice("\u7EE7\u7EED\u6F2B\u6E38\u5931\u8D25");
    }
  }
  async getSmartRecommendations() {
    try {
      const recommendations = await this.plugin.recommendationService.getRecommendations();
      if (recommendations.length === 0) {
        new import_obsidian4.Notice("\u6682\u65E0\u63A8\u8350\u6587\u6863\uFF0C\u8BF7\u6DFB\u52A0\u66F4\u591A\u6587\u6863\u5230\u6F2B\u6E38\u5217\u8868");
        return;
      }
      const topRecommendation = recommendations[0];
      const similarity = (topRecommendation.score * 100).toFixed(1);
      await this.openDocument(topRecommendation.file);
      new import_obsidian4.Notice(`\u{1F9E0} \u667A\u80FD\u63A8\u8350\uFF1A${topRecommendation.file.basename} (\u76F8\u4F3C\u5EA6: ${similarity}%)`);
    } catch (error) {
      console.error("\u667A\u80FD\u63A8\u8350\u5931\u8D25:", error);
      new import_obsidian4.Notice("\u667A\u80FD\u63A8\u8350\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5");
    }
  }
  async refreshData() {
    var _a;
    this.updateStatusText();
    this.updateMetricsSection();
    await this.updateRecommendationsSection();
    this.updateRankingSection();
    (_a = this.actionBar) == null ? void 0 : _a.updateButtonStates();
  }
  updateStatusText() {
    if (this.statusText) {
      const docCount = this.getVisitedDocumentCount();
      this.statusText.textContent = `${docCount} \u7BC7\u6F2B\u6E38\u6587\u6863${docCount === 0 ? " (\u65E0\u6F2B\u6E38\u6587\u6863)" : ""}`;
    }
  }
  async randomRoaming() {
    try {
      const roamingFiles = this.plugin.getValidRoamingFiles();
      if (roamingFiles.length === 0) {
        new import_obsidian4.Notice("\u6682\u65E0\u6F2B\u6E38\u6587\u6863\uFF0C\u8BF7\u5148\u6DFB\u52A0\u6587\u6863\u5230\u6F2B\u6E38\u5217\u8868");
        return;
      }
      const randomIndex = Math.floor(Math.random() * roamingFiles.length);
      const randomFile = roamingFiles[randomIndex];
      await this.openDocument(randomFile);
      new import_obsidian4.Notice(`\u{1F3B2} \u968F\u673A\u6F2B\u6E38\uFF1A${randomFile.basename}`);
    } catch (error) {
      console.error("\u968F\u673A\u6F2B\u6E38\u5931\u8D25:", error);
      new import_obsidian4.Notice("\u968F\u673A\u6F2B\u6E38\u5931\u8D25");
    }
  }
  async addCurrentToRoaming() {
    const activeFile = this.app.workspace.getActiveFile();
    if (!activeFile) {
      new import_obsidian4.Notice("\u6CA1\u6709\u6253\u5F00\u7684\u6587\u6863");
      return;
    }
    try {
      if (activeFile.extension !== "md") {
        new import_obsidian4.Notice(`\u53EA\u80FD\u6DFB\u52A0Markdown\u6587\u6863\u5230\u6F2B\u6E38\u5217\u8868 "${activeFile.basename}"`);
        return;
      }
      if (this.plugin.settings.roamingDocs.includes(activeFile.path)) {
        new import_obsidian4.Notice(`"${activeFile.basename}" \u5DF2\u5728\u6F2B\u6E38\u5217\u8868\u4E2D`);
        return;
      }
      this.plugin.settings.roamingDocs.push(activeFile.path);
      const fileService = this.plugin.fileManagementService;
      const defaultMetrics = fileService.createDefaultMetricsForFile(activeFile);
      await this.plugin.updateDocumentMetrics(activeFile, defaultMetrics);
      await this.plugin.saveSettings();
      new import_obsidian4.Notice(`\u2705 \u5DF2\u5C06 "${activeFile.basename}" \u52A0\u5165\u6F2B\u6E38\u5217\u8868`);
      this.refreshData();
    } catch (error) {
      console.error("\u52A0\u5165\u6F2B\u6E38\u5931\u8D25:", error);
      new import_obsidian4.Notice("\u52A0\u5165\u6F2B\u6E38\u5931\u8D25");
    }
  }
  async openDocument(file) {
    try {
      await this.app.workspace.getLeaf().openFile(file);
    } catch (error) {
      console.error("\u6253\u5F00\u6587\u6863\u5931\u8D25:", error);
      new import_obsidian4.Notice("\u6253\u5F00\u6587\u6863\u5931\u8D25");
    }
  }
  async editDocumentMetrics(file, currentMetrics) {
    try {
      const modal = new DocumentMetricsModal(
        this.app,
        file,
        currentMetrics,
        this.plugin.settings.customMetrics,
        async (updatedMetrics) => {
          await this.plugin.updateDocumentMetrics(file, updatedMetrics);
          new import_obsidian4.Notice(`\u6587\u6863 "${file.basename}" \u7684\u5F97\u5206\u5DF2\u66F4\u65B0`);
          this.refreshData();
        },
        async (realTimeMetrics) => {
          await this.updateDocumentMetricsRealTime(file, realTimeMetrics);
        }
      );
      modal.open();
    } catch (error) {
      console.error("\u7F16\u8F91\u6587\u6863\u5F97\u5206\u5931\u8D25:", error);
      new import_obsidian4.Notice("\u7F16\u8F91\u6587\u6863\u5F97\u5206\u5931\u8D25");
    }
  }
  async updateDocumentMetricsRealTime(file, realTimeMetrics) {
    try {
      this.plugin.settings.documentMetrics[file.path] = {
        ...realTimeMetrics,
        lastVisited: Date.now()
      };
      this.updateRankingSection();
    } catch (error) {
      console.warn("\u5B9E\u65F6\u6307\u6807\u66F4\u65B0\u5931\u8D25:", error);
    }
  }
  calculatePriority(metrics) {
    return this.plugin.documentScoringService.calculatePriority(metrics, this.plugin.settings.customMetrics);
  }
  getVisitedDocumentCount() {
    return this.plugin.settings.roamingDocs.length;
  }
  addStyles() {
  }
  cleanup() {
    this.actionBar = null;
    this.documentMetricsDisplay = null;
    this.navigationTabs = null;
    this.rankingList = null;
    this.recommendationList = null;
  }
};

// src/utils/CacheManager.ts
var CacheManager = class {
  constructor() {
    this.cache = /* @__PURE__ */ new Map();
    this.defaultTTL = 5 * 60 * 1e3;
    // 5 minutes default TTL
    this.maxCacheSize = 1e3;
  }
  /**
   * Get value from cache
   */
  get(key) {
    const entry = this.cache.get(key);
    if (!entry)
      return null;
    if (Date.now() > entry.expires) {
      this.cache.delete(key);
      return null;
    }
    return entry.value;
  }
  /**
   * Set value in cache with optional TTL
   */
  set(key, value, ttl = this.defaultTTL) {
    if (this.cache.size >= this.maxCacheSize) {
      this.evictOldest();
    }
    this.cache.set(key, {
      value,
      timestamp: Date.now(),
      expires: Date.now() + ttl
    });
  }
  /**
   * Delete cache entry
   */
  delete(key) {
    return this.cache.delete(key);
  }
  /**
   * Clear all cache entries
   */
  clear() {
    this.cache.clear();
  }
  /**
   * Evict expired entries
   */
  evictExpired() {
    const now = Date.now();
    for (const [key, entry] of this.cache.entries()) {
      if (now > entry.expires) {
        this.cache.delete(key);
      }
    }
  }
  /**
   * Evict oldest entries
   */
  evictOldest() {
    const entries = Array.from(this.cache.entries());
    entries.sort((a, b) => a[1].timestamp - b[1].timestamp);
    const toDelete = entries.slice(0, Math.floor(this.maxCacheSize * 0.1));
    toDelete.forEach(([key]) => this.cache.delete(key));
  }
  /**
   * Get cache statistics
   */
  getStats() {
    const now = Date.now();
    let expired = 0;
    for (const entry of this.cache.values()) {
      if (now > entry.expires) {
        expired++;
      }
    }
    return {
      size: this.cache.size,
      expired
    };
  }
};
var FileContentCache = class {
  constructor(app) {
    this.cache = new CacheManager();
    this.app = app;
  }
  /**
   * Get file content with caching
   */
  async getFileContent(file, maxLength = 5e4) {
    const cacheKey = `content:${file.path}:${file.stat.mtime}`;
    const cached = this.cache.get(cacheKey);
    if (cached) {
      return cached;
    }
    try {
      const text = await this.app.vault.read(file);
      const truncatedText = text.length > maxLength ? text.substr(0, maxLength) : text;
      const tokens = this.tokenize(truncatedText);
      const content = {
        text: truncatedText,
        tokens,
        lastModified: file.stat.mtime
      };
      this.cache.set(cacheKey, content, 10 * 60 * 1e3);
      return content;
    } catch (error) {
      console.error("Error reading file:", file.path, error);
      return {
        text: "",
        tokens: [],
        lastModified: 0
      };
    }
  }
  /**
   * Simple tokenization for caching
   */
  tokenize(text) {
    return text.toLowerCase().replace(/[^\w\s\u4e00-\u9fff]/g, " ").split(/\s+/).filter((token) => token.length > 2);
  }
  /**
   * Clear cache for specific file
   */
  clearFileCache(file) {
    const stats = this.cache.getStats();
    this.cache.clear();
  }
  /**
   * Get cache statistics
   */
  getStats() {
    return this.cache.getStats();
  }
};
var VectorCache = class {
  constructor() {
    this.cache = new CacheManager();
  }
  /**
   * Get cached vector
   */
  getVector(key) {
    return this.cache.get(key);
  }
  /**
   * Cache a vector
   */
  setVector(key, vector) {
    const magnitude = Math.sqrt(
      Array.from(vector.values()).reduce((sum, val) => sum + val * val, 0)
    );
    const documentVector = {
      vector: new Map(vector),
      // Create copy
      magnitude
    };
    this.cache.set(key, documentVector, 15 * 60 * 1e3);
  }
  /**
   * Calculate cosine similarity using cached magnitudes
   */
  cosineSimilarity(vectorA, vectorB) {
    if (vectorA.magnitude === 0 || vectorB.magnitude === 0)
      return 0;
    let dotProduct = 0;
    const smallerVector = vectorA.vector.size < vectorB.vector.size ? vectorA.vector : vectorB.vector;
    const largerVector = vectorA.vector.size >= vectorB.vector.size ? vectorA.vector : vectorB.vector;
    for (const [term, valueA] of smallerVector) {
      const valueB = largerVector.get(term) || 0;
      dotProduct += valueA * valueB;
    }
    return dotProduct / (vectorA.magnitude * vectorB.magnitude);
  }
  /**
   * Clear all cached vectors
   */
  clear() {
    this.cache.clear();
  }
  /**
   * Get cache statistics
   */
  getStats() {
    return this.cache.getStats();
  }
};

// src/services/RecommendationService.ts
var RecommendationService = class {
  constructor(app, settings) {
    this.documentCache = /* @__PURE__ */ new Map();
    this.app = app;
    this.settings = settings;
    this.fileCache = new FileContentCache(app);
    this.vectorCache = new VectorCache();
  }
  /**
   * Get recommended documents based on Text Cosine Similarity
   */
  async getRecommendations(excludeFile) {
    try {
      console.log("\u5F00\u59CB\u667A\u80FD\u63A8\u8350\u7B97\u6CD5...");
      const files = this.app.vault.getMarkdownFiles();
      const roamingFiles = files.filter(
        (file) => SharedUtils.shouldIncludeFile(file, this.settings.excludedPaths) && file !== excludeFile && this.settings.roamingDocs.includes(file.path)
        // Only include roaming documents
      );
      console.log(`\u627E\u5230 ${roamingFiles.length} \u4E2A\u6F2B\u6E38\u6587\u6863`);
      if (roamingFiles.length === 0) {
        console.log("\u6CA1\u6709\u6F2B\u6E38\u6587\u6863\uFF0C\u8FD4\u56DE\u7A7A\u63A8\u8350");
        return [];
      }
      const currentFile = excludeFile || this.app.workspace.getActiveFile();
      if (!currentFile) {
        console.log("\u6CA1\u6709\u5F53\u524D\u6587\u6863\uFF0C\u6309\u4F18\u5148\u7EA7\u6392\u5E8F\u63A8\u8350\u6F2B\u6E38\u6587\u6863");
        return this.getPriorityBasedRecommendations(roamingFiles);
      }
      console.log(`\u5F53\u524D\u53C2\u8003\u6587\u6863: ${currentFile.basename}`);
      const similarityScores = [];
      for (const roamingFile of roamingFiles) {
        if (roamingFile.path === currentFile.path)
          continue;
        try {
          const similarity = await this.calculateTextSimilarity(currentFile, roamingFile);
          console.log(`${roamingFile.basename} \u76F8\u4F3C\u5EA6: ${similarity.toFixed(4)}`);
          if (similarity > 0) {
            similarityScores.push({ file: roamingFile, score: similarity });
          }
        } catch (error) {
          console.error(`\u8BA1\u7B97 ${roamingFile.basename} \u76F8\u4F3C\u5EA6\u5931\u8D25:`, error);
        }
      }
      similarityScores.sort((a, b) => b.score - a.score);
      console.log(`\u627E\u5230 ${similarityScores.length} \u4E2A\u6709\u76F8\u4F3C\u5EA6\u7684\u6587\u6863`);
      if (similarityScores.length === 0) {
        console.log("\u6CA1\u6709\u76F8\u4F3C\u6587\u6863\uFF0C\u6309\u4F18\u5148\u7EA7\u6392\u5E8F\u63A8\u8350");
        return this.getPriorityBasedRecommendations(roamingFiles);
      }
      const topK = Math.min(this.settings.recommendationSettings.topK, similarityScores.length);
      const result = similarityScores.slice(0, topK);
      console.log(`\u63A8\u8350\u5B8C\u6210\uFF0C\u8FD4\u56DE ${result.length} \u4E2A\u6587\u6863`);
      console.log(`\u53BB\u91CD\u524D\u7684\u63A8\u8350\u7ED3\u679C:`, result.map((r) => ({ name: r.file.basename, path: r.file.path, score: r.score })));
      const uniqueResults = this.deduplicateRecommendations(result);
      console.log(`\u53BB\u91CD\u540E\u7684\u63A8\u8350\u7ED3\u679C:`, uniqueResults.map((r) => ({ name: r.file.basename, path: r.file.path, score: r.score })));
      console.log(`\u53BB\u91CD\u540E\u8FD4\u56DE ${uniqueResults.length} \u4E2A\u6587\u6863`);
      return uniqueResults;
    } catch (error) {
      console.error("\u667A\u80FD\u63A8\u8350\u7B97\u6CD5\u51FA\u9519:", error);
      return [];
    }
  }
  /**
   * 去重逻辑 - 根据文档ID移除重复项
   */
  deduplicateRecommendations(recommendations) {
    const seenFiles = /* @__PURE__ */ new Map();
    const duplicates = [];
    console.log(`\u5F00\u59CB\u53BB\u91CD\uFF0C\u8F93\u5165\u6587\u6863\u6570\u91CF: ${recommendations.length}`);
    for (const recommendation of recommendations) {
      const fileId = recommendation.file.path;
      if (!seenFiles.has(fileId)) {
        seenFiles.set(fileId, recommendation);
      } else {
        const existing = seenFiles.get(fileId);
        if (recommendation.score > existing.score) {
          console.log(`\u53BB\u91CD: \u53D1\u73B0\u91CD\u590D\u6587\u6863 ${recommendation.file.basename}\uFF0C\u4FDD\u7559\u66F4\u9AD8\u5206\u6570 ${recommendation.score.toFixed(4)} > ${existing.score.toFixed(4)}`);
          seenFiles.set(fileId, recommendation);
        } else {
          console.log(`\u53BB\u91CD: \u53D1\u73B0\u91CD\u590D\u6587\u6863 ${recommendation.file.basename}\uFF0C\u4FDD\u7559\u539F\u5206\u6570 ${existing.score.toFixed(4)} > ${recommendation.score.toFixed(4)}`);
        }
        duplicates.push(fileId);
      }
    }
    const uniqueRecommendations = Array.from(seenFiles.values());
    console.log(`\u53BB\u91CD\u5B8C\u6210: \u53D1\u73B0 ${duplicates.length} \u4E2A\u91CD\u590D\u9879\uFF0C\u6700\u7EC8 ${uniqueRecommendations.length} \u4E2A\u552F\u4E00\u6587\u6863`);
    return uniqueRecommendations;
  }
  /**
   * 基于优先级的简单推荐（回退方案）
   */
  getPriorityBasedRecommendations(roamingFiles) {
    const priorityRecs = roamingFiles.sort((a, b) => {
      const aMetrics = this.getDocumentMetrics(a);
      const bMetrics = this.getDocumentMetrics(b);
      return bMetrics.priority - aMetrics.priority;
    }).slice(0, this.settings.recommendationSettings.topK).map((file) => ({
      file,
      score: this.getDocumentMetrics(file).priority / 10
    }));
    return this.deduplicateRecommendations(priorityRecs);
  }
  /**
   * 计算两个文档之间的文本余弦相似度
   */
  async calculateTextSimilarity(file1, file2) {
    try {
      console.log(`\u5F00\u59CB\u8BA1\u7B97 ${file1.basename} \u4E0E ${file2.basename} \u7684\u6587\u672C\u76F8\u4F3C\u5EA6...`);
      const content1 = await this.extractSimpleTextContent(file1);
      const content2 = await this.extractSimpleTextContent(file2);
      console.log(`\u6587\u68631\u5185\u5BB9\u957F\u5EA6: ${content1.length}, \u6587\u68632\u5185\u5BB9\u957F\u5EA6: ${content2.length}`);
      if (!content1 || !content2 || content1.length < 10 || content2.length < 10) {
        console.log("\u6587\u6863\u5185\u5BB9\u592A\u77ED\uFF0C\u8DF3\u8FC7\u76F8\u4F3C\u5EA6\u8BA1\u7B97");
        return 0;
      }
      const tokens1 = this.simpleTokenize(content1);
      const tokens2 = this.simpleTokenize(content2);
      console.log(`\u6587\u68631\u8BCD\u6570: ${tokens1.length}, \u6587\u68632\u8BCD\u6570: ${tokens2.length}`);
      if (tokens1.length === 0 || tokens2.length === 0) {
        console.log("\u5206\u8BCD\u7ED3\u679C\u4E3A\u7A7A\uFF0C\u8DF3\u8FC7\u76F8\u4F3C\u5EA6\u8BA1\u7B97");
        return 0;
      }
      const freq1 = this.calculateWordFrequency(tokens1);
      const freq2 = this.calculateWordFrequency(tokens2);
      const similarity = this.cosineSimilarityFromFreq(freq1, freq2);
      console.log(`\u6700\u7EC8\u76F8\u4F3C\u5EA6: ${similarity.toFixed(4)}`);
      return similarity;
    } catch (error) {
      console.error(`\u8BA1\u7B97\u6587\u672C\u76F8\u4F3C\u5EA6\u5931\u8D25:`, error);
      return 0;
    }
  }
  /**
   * 简化的文本内容提取
   */
  async extractSimpleTextContent(file) {
    try {
      const content = await this.app.vault.read(file);
      return content.replace(/```[\s\S]*?```/g, "").replace(/\[([^\]]+)\]\([^)]+\)/g, "$1").replace(/!\[[^\]]*\]\([^)]+\)/g, "").replace(/#{1,6}\s+/g, " ").replace(/\*\*([^\*]+)\*\*/g, "$1").replace(/\*([^\*]+)\*/g, "$1").replace(/`([^`]+)`/g, "$1").replace(/^\s*[-*+]\s+/gm, "").replace(/^\s*\d+\.\s+/gm, "").replace(/^\s*>\s+/gm, "").replace(/[^\w\s\u4e00-\u9fff]/g, " ").replace(/\s+/g, " ").trim();
    } catch (error) {
      console.error(`\u63D0\u53D6 ${file.basename} \u5185\u5BB9\u5931\u8D25:`, error);
      return "";
    }
  }
  /**
   * 简化的分词方法
   */
  simpleTokenize(text) {
    const tokens = [];
    const lowerText = text.toLowerCase();
    for (let i = 0; i < lowerText.length; i++) {
      const char = lowerText[i];
      if (/[\u4e00-\u9fff]/.test(char)) {
        tokens.push(char);
      } else if (/[a-zA-Z]/.test(char)) {
        let word = char;
        while (i + 1 < lowerText.length && /[a-zA-Z]/.test(lowerText[i + 1])) {
          i++;
          word += lowerText[i];
        }
        if (word.length > 1) {
          tokens.push(word);
        }
      }
    }
    const stopWords = /* @__PURE__ */ new Set(["\u7684", "\u4E86", "\u5728", "\u662F", "\u6211", "\u6709", "\u548C", "\u5C31", "\u4E0D", "the", "a", "an", "and", "or", "but", "in", "on", "at", "to", "for"]);
    return tokens.filter((token) => !stopWords.has(token) && token.length > 0);
  }
  /**
   * 计算词频
   */
  calculateWordFrequency(tokens) {
    const frequency = /* @__PURE__ */ new Map();
    for (const token of tokens) {
      frequency.set(token, (frequency.get(token) || 0) + 1);
    }
    return frequency;
  }
  /**
   * 从词频计算余弦相似度
   */
  cosineSimilarityFromFreq(freq1, freq2) {
    const allWords = /* @__PURE__ */ new Set([...freq1.keys(), ...freq2.keys()]);
    let dotProduct = 0;
    let magnitude1 = 0;
    let magnitude2 = 0;
    for (const word of allWords) {
      const f1 = freq1.get(word) || 0;
      const f2 = freq2.get(word) || 0;
      dotProduct += f1 * f2;
      magnitude1 += f1 * f1;
      magnitude2 += f2 * f2;
    }
    magnitude1 = Math.sqrt(magnitude1);
    magnitude2 = Math.sqrt(magnitude2);
    if (magnitude1 === 0 || magnitude2 === 0)
      return 0;
    return dotProduct / (magnitude1 * magnitude2);
  }
  /**
   * Calculate TF-IDF similarity scores between candidates and anchors
   */
  async calculateSimilarityScores(candidates, anchors) {
    try {
      const { vocabulary, documentFrequencies, totalDocs } = await this.buildVocabulary([...candidates, ...anchors]);
      const anchorVectors = [];
      for (const anchor of anchors) {
        const vector = await this.getOrCalculateTfIdfVector(anchor, vocabulary, documentFrequencies, totalDocs);
        anchorVectors.push(vector);
      }
      const scores = [];
      for (const candidate of candidates) {
        const candidateVector = await this.getOrCalculateTfIdfVector(candidate, vocabulary, documentFrequencies, totalDocs);
        let totalSimilarity = 0;
        let validAnchorCount = 0;
        for (let i = 0; i < anchors.length; i++) {
          const similarity = this.cosineSimilarity(candidateVector, anchorVectors[i]);
          if (similarity > 0) {
            totalSimilarity += similarity;
            validAnchorCount++;
          }
        }
        const avgSimilarity = validAnchorCount > 0 ? totalSimilarity / validAnchorCount : 0;
        const metrics = this.getDocumentMetrics(candidate);
        const priorityScore = SharedUtils.calculatePriority(metrics, this.settings.metricWeights, this.settings.customMetrics) / 50;
        const daysSinceVisit = metrics.lastVisited ? (Date.now() - metrics.lastVisited) / (1e3 * 60 * 60 * 24) : 999;
        const recencyScore = Math.min(daysSinceVisit / 30, 1);
        const visitScore = Math.max(0, 1 - metrics.visitCount * 0.1);
        const finalScore = avgSimilarity * 0.4 + priorityScore * 0.3 + recencyScore * 0.2 + visitScore * 0.1;
        scores.push({ file: candidate, score: finalScore });
      }
      scores.sort((a, b) => b.score - a.score);
      return scores;
    } catch (error) {
      console.error("Error calculating similarity scores:", error);
      return candidates.map((file) => {
        const metrics = this.settings.documentMetrics[file.path] || {
          lastVisited: Date.now(),
          visitCount: 0
        };
        const priority = SharedUtils.calculatePriority(metrics, this.settings.metricWeights, this.settings.customMetrics);
        return { file, score: priority / 10 };
      });
    }
  }
  /**
   * Build vocabulary and calculate document frequencies
   */
  async buildVocabulary(files) {
    const vocabulary = /* @__PURE__ */ new Set();
    const documentFrequencies = /* @__PURE__ */ new Map();
    const totalDocs = files.length;
    for (const file of files) {
      const tokens = await this.getDocumentTokens(file);
      const uniqueTokens = new Set(tokens);
      for (const token of uniqueTokens) {
        vocabulary.add(token);
        documentFrequencies.set(token, (documentFrequencies.get(token) || 0) + 1);
      }
    }
    return { vocabulary, documentFrequencies, totalDocs };
  }
  /**
   * Get or calculate TF-IDF vector with caching
   */
  async getOrCalculateTfIdfVector(file, vocabulary, documentFrequencies, totalDocs) {
    const cacheKey = `tfidf:${file.path}:${file.stat.mtime}`;
    const cached = this.vectorCache.getVector(cacheKey);
    if (cached) {
      return cached.vector;
    }
    const tokens = await this.getDocumentTokens(file);
    const vector = this.calculateTfIdfVector(tokens, vocabulary, documentFrequencies, totalDocs);
    this.vectorCache.setVector(cacheKey, vector);
    return vector;
  }
  /**
   * Get document tokens with caching
   */
  async getDocumentTokens(file) {
    const cacheKey = `${file.path}-${file.stat.mtime}`;
    const cached = this.documentCache.get(cacheKey);
    if (cached) {
      return cached.tokens;
    }
    const content = await this.extractTextContent(file);
    const tokens = this.tokenize(content);
    this.documentCache.set(cacheKey, { content, tokens });
    return tokens;
  }
  async getAnchorDocuments(files) {
    const anchors = [];
    const recentVisited = files.filter(
      (file) => this.settings.roamingDocs.includes(file.path)
    );
    recentVisited.sort((a, b) => {
      const aTime = this.getDocumentMetrics(a).lastVisited || 0;
      const bTime = this.getDocumentMetrics(b).lastVisited || 0;
      return bTime - aTime;
    });
    const recentAnchors = recentVisited.slice(0, this.settings.recommendationSettings.recentCount);
    const withVisitCount = files.map((file) => ({
      file,
      visitCount: this.getDocumentMetrics(file).visitCount
    }));
    withVisitCount.sort((a, b) => b.visitCount - a.visitCount);
    const topVisitedAnchors = withVisitCount.slice(0, this.settings.recommendationSettings.topCount).map((item) => item.file);
    const allAnchors = [...recentAnchors, ...topVisitedAnchors];
    for (const file of allAnchors) {
      if (!anchors.some((a) => a.path === file.path)) {
        anchors.push(file);
      }
    }
    return anchors;
  }
  calculateTfIdfVector(tokens, vocabulary, documentFrequencies, totalDocs) {
    const vector = /* @__PURE__ */ new Map();
    const termFrequencies = /* @__PURE__ */ new Map();
    for (const token of tokens) {
      termFrequencies.set(token, (termFrequencies.get(token) || 0) + 1);
    }
    let vectorSum = 0;
    for (const [term, tf] of termFrequencies) {
      const df = documentFrequencies.get(term) || 1;
      const idf = Math.log(totalDocs / df);
      const tfidf = tf / tokens.length * idf;
      vector.set(term, tfidf);
      vectorSum += tfidf * tfidf;
    }
    const magnitude = Math.sqrt(vectorSum);
    if (magnitude > 0) {
      for (const [term, value] of vector) {
        vector.set(term, value / magnitude);
      }
    }
    return vector;
  }
  cosineSimilarity(vectorA, vectorB) {
    let dotProduct = 0;
    let magnitudeA = 0;
    let magnitudeB = 0;
    for (const [term, valueA] of vectorA) {
      const valueB = vectorB.get(term) || 0;
      if (valueB !== 0) {
        dotProduct += valueA * valueB;
      }
    }
    for (const valueA of vectorA.values()) {
      magnitudeA += valueA * valueA;
    }
    magnitudeA = Math.sqrt(magnitudeA);
    for (const valueB of vectorB.values()) {
      magnitudeB += valueB * valueB;
    }
    magnitudeB = Math.sqrt(magnitudeB);
    if (magnitudeA === 0 || magnitudeB === 0)
      return 0;
    return dotProduct / (magnitudeA * magnitudeB);
  }
  async extractTextContent(file) {
    const content = await this.app.vault.read(file);
    const cleanContent = content.replace(/```[\s\S]*?```/g, " ").replace(/\[([^\]]+)\]\([^)]+\)/g, "$1").replace(/!\[[^\]]*\]\([^)]+\)/g, " ").replace(/^\s*>\s+/gm, " ").replace(/\n{3,}/g, "\n\n").trim();
    const titleMatch = cleanContent.match(/^#{1,6}\s+(.+)$/m);
    const title = titleMatch ? titleMatch[1] : "";
    const paragraphs = cleanContent.split(/\n\n+/).filter((p) => p.trim().length > 5).map(
      (p) => p.replace(/#{1,6}\s+/g, "").replace(/\*\*([^\*]+)\*\*/g, "$1").replace(/\*([^\*]+)\*/g, "$1").replace(/`([^`]+)`/g, "$1").replace(/^\s*[-*+]\s+/gm, "").replace(/^\s*\d+\.\s+/gm, "").trim()
    ).filter((p) => p.length > 3);
    const maxParagraphs = this.settings.recommendationSettings.maxParagraphs;
    let selectedTexts = [];
    if (title) {
      selectedTexts.push(title);
    }
    if (paragraphs.length > 0) {
      const sampleSize = Math.min(maxParagraphs - 1, paragraphs.length);
      if (sampleSize === 1) {
        selectedTexts.push(paragraphs[0]);
      } else if (sampleSize === 2) {
        selectedTexts.push(paragraphs[0]);
        selectedTexts.push(paragraphs[paragraphs.length - 1]);
      } else {
        selectedTexts.push(paragraphs[0]);
        const middleIndex = Math.floor(paragraphs.length / 2);
        selectedTexts.push(paragraphs[middleIndex]);
        selectedTexts.push(paragraphs[paragraphs.length - 1]);
      }
    }
    return selectedTexts.join(" ");
  }
  tokenize(text) {
    const tokens = [];
    const lowerText = text.toLowerCase();
    for (let i = 0; i < lowerText.length; i++) {
      const char = lowerText[i];
      if (/[\u4e00-\u9fff]/.test(char)) {
        tokens.push(char);
      } else if (/[a-zA-Z]/.test(char)) {
        let word = char;
        while (i + 1 < lowerText.length && /[a-zA-Z]/.test(lowerText[i + 1])) {
          i++;
          word += lowerText[i];
        }
        if (word.length > 1) {
          tokens.push(word);
        }
      }
    }
    return tokens.filter((token) => !this.isStopWord(token));
  }
  isStopWord(token) {
    const stopWords = /* @__PURE__ */ new Set([
      // English
      "the",
      "a",
      "an",
      "and",
      "or",
      "but",
      "in",
      "on",
      "at",
      "to",
      "for",
      "of",
      "with",
      "by",
      "is",
      "are",
      "was",
      "were",
      "be",
      "been",
      "being",
      "have",
      "has",
      "had",
      "do",
      "does",
      "did",
      "will",
      "would",
      "could",
      "should",
      "may",
      "might",
      "must",
      "can",
      "this",
      "that",
      "these",
      "those",
      "i",
      "you",
      "he",
      "she",
      "it",
      "we",
      "they",
      "what",
      "which",
      "who",
      "when",
      "where",
      "why",
      "how",
      "all",
      "any",
      "both",
      "each",
      "few",
      "more",
      "most",
      "other",
      "some",
      "such",
      "no",
      "nor",
      "not",
      "only",
      "own",
      "same",
      "so",
      "than",
      "too",
      "very",
      "just",
      // Chinese
      "\u7684",
      "\u4E86",
      "\u5728",
      "\u662F",
      "\u6211",
      "\u6709",
      "\u548C",
      "\u5C31",
      "\u4E0D",
      "\u4EBA",
      "\u90FD",
      "\u4E00",
      "\u4E00\u4E2A",
      "\u4E0A",
      "\u4E5F",
      "\u5F88",
      "\u5230",
      "\u8BF4",
      "\u8981",
      "\u53BB",
      "\u4F60",
      "\u4F1A",
      "\u7740",
      "\u6CA1\u6709",
      "\u770B",
      "\u597D",
      "\u81EA\u5DF1",
      "\u8FD9",
      "\u90A3",
      "\u91CC",
      "\u5C31\u662F",
      "\u8FD8",
      "\u628A",
      "\u6BD4",
      "\u4ECE",
      "\u88AB",
      "\u672C",
      "\u4E2A",
      "\u4E2D",
      "\u5927",
      "\u4E3A",
      "\u6765",
      "\u4EE5",
      "\u65F6",
      "\u548C",
      "\u7528",
      "\u4E0B",
      "\u800C",
      "\u53CA",
      "\u4E0E",
      "\u5176",
      "\u6216",
      "\u4F46",
      "\u5982",
      "\u82E5",
      "\u5219",
      "\u56E0",
      "\u6240\u4EE5",
      "\u5982\u679C",
      "\u867D\u7136",
      "\u5C3D\u7BA1",
      "\u65E0\u8BBA",
      "\u4E0D\u7BA1",
      "\u9664\u4E86",
      "\u9664\u975E",
      "\u76F4\u5230",
      "\u5F53",
      "\u5728...\u65F6\u5019",
      "\u5173\u4E8E",
      "\u5BF9\u4E8E",
      "\u81F3\u4E8E",
      "\u7531\u4E8E",
      "\u56E0\u4E3A",
      "\u6240\u4EE5",
      "\u4EE5\u4FBF",
      "\u4E3A\u4E86",
      "\u6309\u7167",
      "\u6839\u636E",
      "\u4F9D\u636E"
    ]);
    return stopWords.has(token);
  }
  getDocumentMetrics(file) {
    return SharedUtils.getDocumentMetrics(file, this.settings);
  }
  calculatePriorityScore(metrics) {
    return SharedUtils.calculatePriority(metrics, this.settings.metricWeights, this.settings.customMetrics);
  }
};

// src/models/Settings.ts
var DEFAULT_SETTINGS = {
  excludeVisited: true,
  roamingDocs: [],
  // 手动添加的漫游文档
  documentMetrics: {},
  customMetrics: [
    { id: "importance", name: "\u91CD\u8981\u6027", weight: 40 },
    { id: "urgency", name: "\u7D27\u6025\u5EA6", weight: 30 },
    { id: "completion", name: "\u5B8C\u6210\u5EA6", weight: 30 }
  ],
  metricWeights: {
    importance: 40,
    urgency: 30,
    completion: 30
  },
  recommendationSettings: {
    recentCount: 5,
    topCount: 5,
    topK: 10,
    maxCandidates: 100,
    maxParagraphs: 5
  },
  excludedPaths: [
    "Templates/**",
    "Scripts/**",
    "Archive/**",
    ".obsidian/**",
    "**/.git/**"
  ],
  maxCandidates: 100,
  language: "en",
  // 默认英语
  version: "2.0.0"
  // 当前版本 - 更新版本号表示重大更新
};

// src/services/FileManagementService.ts
var import_obsidian5 = require("obsidian");
var FileManagementService = class {
  constructor(app, settings) {
    this.app = app;
    this.settings = settings;
  }
  /**
   * 递归获取文件夹中的所有Markdown文件
   */
  async getFilesInFolder(folderPath) {
    const files = [];
    const folder = this.app.vault.getAbstractFileByPath(folderPath);
    if (!folder || !(folder instanceof import_obsidian5.TFolder)) {
      return files;
    }
    const allFiles = this.app.vault.getAllLoadedFiles();
    for (const file of allFiles) {
      if (file instanceof import_obsidian5.TFile && file.extension === "md" && (file.path.startsWith(folder.path + "/") || file.path === folder.path)) {
        files.push(file);
      }
    }
    return files;
  }
  /**
   * 批量添加文件夹到漫游列表
   */
  async addFoldersToRoaming(folderPaths) {
    let addedCount = 0;
    const MAX_FILES = 1e3;
    for (const folderPath of folderPaths) {
      try {
        const files = await this.getFilesInFolder(folderPath);
        for (const file of files) {
          if (addedCount >= MAX_FILES) {
            new import_obsidian5.Notice(`\u5DF2\u8FBE\u5230\u6700\u5927\u6587\u4EF6\u6570\u91CF\u9650\u5236 (${MAX_FILES})\uFF0C\u505C\u6B62\u6DFB\u52A0\u66F4\u591A\u6587\u4EF6`);
            break;
          }
          if (!this.settings.roamingDocs.includes(file.path)) {
            this.settings.roamingDocs.push(file.path);
            addedCount++;
          }
        }
      } catch (error) {
        console.error(`\u6DFB\u52A0\u6587\u4EF6\u5939 ${folderPath} \u5931\u8D25:`, error);
        new import_obsidian5.Notice(`\u6DFB\u52A0\u6587\u4EF6\u5939 ${folderPath} \u5931\u8D25`);
      }
    }
    return addedCount;
  }
  /**
   * 批量添加文件到漫游列表
   */
  async addMultipleFilesToRoaming(files) {
    let addedCount = 0;
    for (const file of files) {
      if (!this.settings.roamingDocs.includes(file.path)) {
        this.settings.roamingDocs.push(file.path);
        addedCount++;
      }
    }
    return addedCount;
  }
  /**
   * 获取有效的漫游文档列表
   */
  getValidRoamingFiles() {
    return this.settings.roamingDocs.map((path) => this.app.vault.getAbstractFileByPath(path)).filter((file) => {
      return file instanceof import_obsidian5.TFile && file.extension === "md";
    });
  }
  /**
   * 获取有效的漫游文档路径列表
   */
  getValidRoamingPaths() {
    return this.getValidRoamingFiles().map((file) => file.path);
  }
  /**
   * 检查文件是否应该被包含
   */
  shouldIncludeFile(file) {
    return SharedUtils.shouldIncludeFile(file, this.settings.excludedPaths);
  }
  /**
   * 获取所有Markdown文件（排除漫游文档）
   */
  getAvailableFilesForRoaming() {
    const allFiles = this.app.vault.getMarkdownFiles();
    const validRoamingPaths = this.getValidRoamingPaths();
    return allFiles.filter(
      (file) => this.shouldIncludeFile(file) && !validRoamingPaths.includes(file.path)
    );
  }
  /**
   * 随机选择一个未访问的文档
   */
  getRandomUnvisitedFile() {
    const availableFiles = this.getAvailableFilesForRoaming();
    if (availableFiles.length === 0) {
      return null;
    }
    const randomIndex = Math.floor(Math.random() * availableFiles.length);
    return availableFiles[randomIndex];
  }
  /**
   * 创建文档的默认指标
   */
  createDefaultMetricsForFile(file) {
    const defaultMetrics = {
      lastVisited: Date.now(),
      visitCount: 0
    };
    for (const metric of this.settings.customMetrics) {
      defaultMetrics[metric.id] = 5;
    }
    return defaultMetrics;
  }
};

// src/services/DocumentScoringService.ts
var DocumentScoringService = class {
  constructor(settings) {
    this.settings = settings;
  }
  /**
   * 计算文档的优先级分数
   */
  calculatePriority(metrics, customMetrics) {
    var _a;
    let totalScore = 0;
    let totalWeight = 0;
    for (const metric of customMetrics) {
      const metricValue = (_a = metrics[metric.id]) != null ? _a : 5;
      const metricWeight = this.settings.metricWeights[metric.id] || metric.weight;
      totalScore += metricValue * (metricWeight / 100);
      totalWeight += metricWeight / 100;
    }
    return totalWeight > 0 ? totalScore / totalWeight * 10 : 0;
  }
  /**
   * 获取文档指标（带默认值）
   */
  getDocumentMetrics(file) {
    const filePath = file.path;
    const stored = this.settings.documentMetrics[filePath];
    if (stored) {
      return stored;
    }
    const defaultMetrics = {
      lastVisited: 0,
      visitCount: 0
    };
    for (const metric of this.settings.customMetrics) {
      defaultMetrics[metric.id] = 5;
    }
    return defaultMetrics;
  }
  /**
   * 更新文档指标
   */
  updateDocumentMetrics(file, metrics) {
    const filePath = file.path;
    const currentMetrics = this.getDocumentMetrics(file);
    const updatedMetrics = {
      ...currentMetrics,
      ...metrics,
      lastVisited: Date.now()
    };
    const hasMetricUpdate = Object.keys(metrics).some(
      (key) => key !== "lastVisited" && key !== "visitCount" && metrics[key] !== void 0
    );
    if (hasMetricUpdate) {
      updatedMetrics.visitCount = currentMetrics.visitCount + 1;
    }
    return updatedMetrics;
  }
  /**
   * 验证指标值是否在有效范围内
   */
  validateMetrics(metrics) {
    const validated = {};
    for (const metric of this.settings.customMetrics) {
      if (metrics[metric.id] !== void 0) {
        validated[metric.id] = Math.max(0, Math.min(10, Number(metrics[metric.id])));
      }
    }
    if (metrics.lastVisited !== void 0) {
      validated.lastVisited = Math.max(0, Number(metrics.lastVisited));
    }
    if (metrics.visitCount !== void 0) {
      validated.visitCount = Math.max(0, Math.floor(Number(metrics.visitCount)));
    }
    return validated;
  }
  /**
   * 获取优先级颜色
   */
  getPriorityColor(priority) {
    if (priority >= 8)
      return "#dc3545";
    if (priority >= 6)
      return "#fd7e14";
    if (priority >= 4)
      return "#ffc107";
    if (priority >= 2)
      return "#28a745";
    return "#6c757d";
  }
  /**
   * 获取文档的详细权重分析
   */
  getWeightBreakdown(metrics) {
    const breakdown = [];
    for (const metric of this.settings.customMetrics) {
      const metricValue = metrics[metric.id] || 5;
      const metricWeight = this.settings.metricWeights[metric.id] || metric.weight;
      const normalizedWeight = metricWeight / 100;
      const score = metricValue * normalizedWeight;
      breakdown.push({
        name: metric.name,
        value: metricValue,
        weight: metricWeight,
        score
      });
    }
    return breakdown;
  }
  /**
   * 比较两个文档的优先级
   */
  compareDocumentPriority(file1, file2) {
    const metrics1 = this.getDocumentMetrics(file1);
    const metrics2 = this.getDocumentMetrics(file2);
    const priority1 = this.calculatePriority(metrics1, this.settings.customMetrics);
    const priority2 = this.calculatePriority(metrics2, this.settings.customMetrics);
    return priority2 - priority1;
  }
  /**
   * 获取推荐文档（按优先级排序）
   */
  getRecommendedDocuments(files, limit = 10) {
    const documentsWithPriority = files.map((file) => {
      const metrics = this.getDocumentMetrics(file);
      const priority = this.calculatePriority(metrics, this.settings.customMetrics);
      return { file, priority };
    });
    documentsWithPriority.sort((a, b) => b.priority - a.priority);
    return documentsWithPriority.slice(0, limit).map((item) => item.file);
  }
};

// src/settings/CustomMetricsSettings.ts
var import_obsidian6 = require("obsidian");
var CustomMetricsSettings = class {
  constructor(containerEl, plugin) {
    this.containerEl = containerEl;
    this.plugin = plugin;
  }
  render() {
    if (!this.contentEl) {
      this.contentEl = this.containerEl.createEl("div", { cls: "custom-metrics-settings-content" });
    } else {
      this.contentEl.empty();
    }
    this.contentEl.createEl("h3", { text: "\u{1F4CA} \u81EA\u5B9A\u4E49\u6307\u6807\u8BBE\u7F6E" });
    this.createMetricManagementHeader();
    this.createCustomMetricsList();
  }
  createMetricManagementHeader() {
    new import_obsidian6.Setting(this.contentEl).setName("\u81EA\u5B9A\u4E49\u6307\u6807\u7BA1\u7406").setDesc("\u81EA\u5B9A\u4E49\u6307\u6807\u7528\u4E8E\u8BC4\u4F30\u6587\u6863\u4F18\u5148\u7EA7\u3002\u60A8\u53EF\u4EE5\u6DFB\u52A0\u3001\u5220\u9664\u548C\u91CD\u547D\u540D\u6307\u6807\uFF0C\u4EE5\u53CA\u8C03\u6574\u6BCF\u4E2A\u6307\u6807\u7684\u6743\u91CD\u3002").addButton((button) => button.setButtonText("+ \u6DFB\u52A0\u65B0\u6307\u6807").setCta().onClick(() => this.addNewMetric()));
  }
  createCustomMetricsList() {
    var _a;
    const metricsContainer = this.contentEl.createEl("div", { cls: "custom-metrics-container" });
    metricsContainer.createEl("h4", { text: "\u81EA\u5B9A\u4E49\u6307\u6807" });
    metricsContainer.createEl("p", {
      text: "\u81EA\u5B9A\u4E49\u6307\u6807\u7528\u4E8E\u8BC4\u4F30\u6587\u6863\u4F18\u5148\u7EA7\u3002\u60A8\u53EF\u4EE5\u6DFB\u52A0\u3001\u5220\u9664\u548C\u91CD\u547D\u540D\u6307\u6807\uFF0C\u4EE5\u53CA\u8C03\u6574\u6BCF\u4E2A\u6307\u6807\u7684\u6743\u91CD\u3002",
      cls: "setting-item-description"
    });
    const metricsList = metricsContainer.createEl("div", { cls: "metrics-list" });
    (_a = this.plugin.settings.customMetrics) == null ? void 0 : _a.forEach((metric, index) => {
      this.createMetricSetting(metricsList, metric, index);
    });
  }
  createMetricSetting(container, metric, index) {
    const metricItem = container.createEl("div", { cls: "metric-setting-item" });
    const titleSetting = new import_obsidian6.Setting(metricItem).setName(`\u81EA\u5B9A\u4E49\u6307\u6807 ${index + 1}`).setDesc(`\u6307\u6807\u540D\u79F0: ${metric.name}`).addButton((button) => button.setButtonText("\u5220\u9664").setWarning().onClick(() => this.deleteMetric(index)));
    new import_obsidian6.Setting(metricItem).setName("\u6307\u6807\u540D\u79F0").setDesc("\u6307\u6807\u7684\u663E\u793A\u540D\u79F0\uFF0C\u5C06\u7528\u4E8E\u754C\u9762\u663E\u793A").addText((text) => text.setPlaceholder("\u4F8B\u5982\uFF1A\u91CD\u8981\u6027").setValue(metric.name).onChange(async (value) => {
      const newName = value || `\u6307\u6807\u540D\u79F0${index + 1}`;
      const oldId = this.plugin.settings.customMetrics[index].id;
      const newId = this.generateMetricId(newName);
      this.plugin.settings.customMetrics[index].name = newName;
      this.plugin.settings.customMetrics[index].id = newId;
      if (oldId !== newId) {
        await this.updateMetricIdInAllDocuments(oldId, newId);
      }
      await this.saveSettings();
      this.refresh();
    }));
    new import_obsidian6.Setting(metricItem).setName("\u6743\u91CD").setDesc("\u8BE5\u6307\u6807\u5728\u603B\u8BC4\u5206\u4E2D\u7684\u6743\u91CD\u767E\u5206\u6BD4\uFF08\u6240\u6709\u6307\u6807\u6743\u91CD\u5C06\u81EA\u52A8\u5F52\u4E00\u5316\u4E3A100%\uFF09").addSlider((slider) => slider.setLimits(0, 100, 1).setValue(metric.weight).setDynamicTooltip().onChange(async (value) => {
      this.plugin.settings.customMetrics[index].weight = Math.floor(value);
      await this.normalizeMetricWeights();
      await this.saveSettings();
      this.refresh();
    }));
  }
  /**
   * 添加新指标
   */
  async addNewMetric() {
    var _a;
    const currentCount = ((_a = this.plugin.settings.customMetrics) == null ? void 0 : _a.length) || 0;
    if (currentCount >= 10) {
      new import_obsidian6.Notice("\u6700\u591A\u652F\u630110\u4E2A\u81EA\u5B9A\u4E49\u6307\u6807");
      return;
    }
    try {
      const newMetric = {
        id: this.generateMetricId(`\u81EA\u5B9A\u4E49\u6307\u6807${currentCount + 1}`),
        name: `\u81EA\u5B9A\u4E49\u6307\u6807${currentCount + 1}`,
        weight: Math.floor(100 / (currentCount + 1))
      };
      this.plugin.settings.customMetrics.push(newMetric);
      await this.normalizeMetricWeights();
      await this.addDefaultValuesForNewMetrics(currentCount, currentCount + 1);
      await this.saveSettings();
      this.refresh();
      new import_obsidian6.Notice("\u2705 \u5DF2\u6DFB\u52A0\u65B0\u6307\u6807");
    } catch (error) {
      console.error("\u6DFB\u52A0\u6307\u6807\u5931\u8D25:", error);
      new import_obsidian6.Notice("\u6DFB\u52A0\u6307\u6807\u5931\u8D25");
    }
  }
  /**
   * 删除指标
   */
  async deleteMetric(index) {
    const metricToDelete = this.plugin.settings.customMetrics[index];
    if (!metricToDelete) {
      console.warn("\u8981\u5220\u9664\u7684\u6307\u6807\u4E0D\u5B58\u5728\uFF0Cindex:", index);
      return;
    }
    try {
      console.log(`\u5F00\u59CB\u5220\u9664\u6307\u6807: ${metricToDelete.name} (ID: ${metricToDelete.id})`);
      const confirmed = await this.showDeleteConfirmation(metricToDelete.name);
      if (!confirmed) {
        console.log("\u7528\u6237\u53D6\u6D88\u4E86\u5220\u9664\u64CD\u4F5C");
        return;
      }
      this.plugin.settings.customMetrics.splice(index, 1);
      console.log("\u5DF2\u4ECE\u8BBE\u7F6E\u4E2D\u5220\u9664\u6307\u6807");
      await this.removeMetricFromAllDocuments(metricToDelete.id);
      console.log("\u5DF2\u4ECE\u6240\u6709\u6587\u6863\u4E2D\u5220\u9664\u6307\u6807\u6570\u636E");
      await this.normalizeMetricWeights();
      console.log("\u5DF2\u91CD\u65B0\u5F52\u4E00\u5316\u6743\u91CD");
      await this.saveSettings();
      console.log("\u5DF2\u4FDD\u5B58\u8BBE\u7F6E");
      this.refresh();
      console.log("\u5DF2\u5237\u65B0\u754C\u9762");
      new import_obsidian6.Notice(`\u2705 \u5DF2\u5220\u9664\u6307\u6807"${metricToDelete.name}"`);
    } catch (error) {
      console.error("\u5220\u9664\u6307\u6807\u5931\u8D25:", error);
      new import_obsidian6.Notice("\u5220\u9664\u6307\u6807\u5931\u8D25");
      try {
        this.refresh();
      } catch (refreshError) {
        console.error("\u5237\u65B0\u754C\u9762\u5931\u8D25:", refreshError);
      }
    }
  }
  /**
   * 显示删除确认对话框
   */
  async showDeleteConfirmation(metricName) {
    return new Promise((resolve) => {
      const modal = document.createElement("div");
      modal.className = "delete-confirmation-modal";
      modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
      const content = document.createElement("div");
      content.className = "modal-content";
      content.style.cssText = `
                background-color: var(--background-primary);
                border: 1px solid var(--background-modifier-border);
                border-radius: 6px;
                padding: 20px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            `;
      content.innerHTML = `
                <h3 style="margin-top: 0; color: var(--text-normal);">\u786E\u8BA4\u5220\u9664</h3>
                <p style="color: var(--text-normal);">\u786E\u5B9A\u8981\u5220\u9664\u6307\u6807"${metricName}"\u5417\uFF1F</p>
                <p class="warning" style="color: var(--text-error); font-weight: bold;">\u26A0\uFE0F \u6B64\u64CD\u4F5C\u5C06\u5220\u9664\u6240\u6709\u6587\u6863\u4E2D\u8BE5\u6307\u6807\u7684\u8BC4\u5206\u6570\u636E\uFF0C\u4E14\u65E0\u6CD5\u6062\u590D\uFF01</p>
                <div class="modal-buttons" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="cancel-btn" style="padding: 8px 16px; border: 1px solid var(--background-modifier-border); background-color: var(--interactive-normal); color: var(--text-normal); border-radius: 4px; cursor: pointer;">\u53D6\u6D88</button>
                    <button class="confirm-btn" style="padding: 8px 16px; border: none; background-color: var(--interactive-destructive); color: var(--text-on-accent); border-radius: 4px; cursor: pointer;">\u5220\u9664</button>
                </div>
            `;
      modal.appendChild(content);
      document.body.appendChild(modal);
      const cancelBtn = content.querySelector(".cancel-btn");
      const confirmBtn = content.querySelector(".confirm-btn");
      const cleanup = () => {
        if (document.body.contains(modal)) {
          document.body.removeChild(modal);
        }
      };
      cancelBtn.onclick = () => {
        cleanup();
        resolve(false);
      };
      confirmBtn.onclick = () => {
        cleanup();
        resolve(true);
      };
      modal.onclick = (e) => {
        if (e.target === modal) {
          cleanup();
          resolve(false);
        }
      };
      const handleEsc = (e) => {
        if (e.key === "Escape") {
          document.removeEventListener("keydown", handleEsc);
          cleanup();
          resolve(false);
        }
      };
      document.addEventListener("keydown", handleEsc);
    });
  }
  /**
   * 从所有文档中删除指标数据
   */
  async removeMetricFromAllDocuments(metricId) {
    try {
      const roamingFiles = this.plugin.fileManagementService.getValidRoamingFiles();
      let removedCount = 0;
      let errorCount = 0;
      console.log(`\u5F00\u59CB\u4ECE ${roamingFiles.length} \u4E2A\u6587\u6863\u4E2D\u5220\u9664\u6307\u6807\u6570\u636E: ${metricId}`);
      for (const file of roamingFiles) {
        try {
          const currentMetrics = this.plugin.settings.documentMetrics[file.path];
          if (currentMetrics && currentMetrics.hasOwnProperty(metricId)) {
            delete currentMetrics[metricId];
            removedCount++;
            const remainingKeys = Object.keys(currentMetrics).filter(
              (key) => key !== "lastVisited" && key !== "visitCount"
            );
            if (remainingKeys.length === 0) {
              const basicInfo = {
                lastVisited: currentMetrics.lastVisited || Date.now(),
                visitCount: currentMetrics.visitCount || 0
              };
              this.plugin.settings.documentMetrics[file.path] = basicInfo;
            }
          }
        } catch (fileError) {
          console.error(`\u5904\u7406\u6587\u4EF6 ${file.path} \u65F6\u51FA\u9519:`, fileError);
          errorCount++;
        }
      }
      console.log(`\u6307\u6807\u5220\u9664\u5B8C\u6210: \u4ECE ${removedCount} \u4E2A\u6587\u6863\u4E2D\u5220\u9664\u4E86\u6570\u636E\uFF0C${errorCount} \u4E2A\u6587\u6863\u5904\u7406\u5931\u8D25`);
      if (errorCount > 0) {
        console.warn(`\u5220\u9664\u6307\u6807\u65F6\u9047\u5230 ${errorCount} \u4E2A\u9519\u8BEF\uFF0C\u4F46\u64CD\u4F5C\u7EE7\u7EED\u5B8C\u6210`);
      }
    } catch (error) {
      console.error(`\u5220\u9664\u6240\u6709\u6587\u6863\u4E2D\u7684\u6307\u6807\u6570\u636E\u65F6\u53D1\u751F\u4E25\u91CD\u9519\u8BEF:`, error);
      throw error;
    }
  }
  /**
   * 更新所有文档中的指标ID（当指标重命名时）
   */
  async updateMetricIdInAllDocuments(oldId, newId) {
    const roamingFiles = this.plugin.fileManagementService.getValidRoamingFiles();
    let updatedCount = 0;
    for (const file of roamingFiles) {
      const currentMetrics = this.plugin.settings.documentMetrics[file.path];
      if (currentMetrics && oldId in currentMetrics) {
        currentMetrics[newId] = currentMetrics[oldId];
        delete currentMetrics[oldId];
        updatedCount++;
      }
    }
    if (updatedCount > 0) {
      console.log(`\u5DF2\u5728 ${updatedCount} \u4E2A\u6587\u6863\u4E2D\u66F4\u65B0\u6307\u6807ID: ${oldId} -> ${newId}`);
    }
  }
  /**
   * 为现有文档添加新指标的默认值
   */
  async addDefaultValuesForNewMetrics(oldCount, newCount) {
    try {
      const roamingFiles = this.plugin.fileManagementService.getValidRoamingFiles();
      const allMetrics = this.plugin.settings.customMetrics;
      const newMetrics = allMetrics.slice(oldCount);
      if (newMetrics.length === 0)
        return;
      let updatedCount = 0;
      for (const file of roamingFiles) {
        let hasUpdates = false;
        const currentMetrics = this.plugin.settings.documentMetrics[file.path] || {
          lastVisited: Date.now(),
          visitCount: 0
        };
        for (const metric of newMetrics) {
          if (!(metric.id in currentMetrics)) {
            currentMetrics[metric.id] = 5;
            hasUpdates = true;
          }
        }
        if (hasUpdates) {
          this.plugin.settings.documentMetrics[file.path] = currentMetrics;
          updatedCount++;
        }
      }
      if (updatedCount > 0) {
        await this.plugin.saveSettings();
        new import_obsidian6.Notice(`\u2705 \u5DF2\u4E3A ${updatedCount} \u4E2A\u73B0\u6709\u6587\u6863\u6DFB\u52A0\u65B0\u6307\u6807\u7684\u9ED8\u8BA4\u503C\uFF085.0\u5206\uFF09`);
      }
    } catch (error) {
      console.error("\u4E3A\u65B0\u6307\u6807\u6DFB\u52A0\u9ED8\u8BA4\u503C\u5931\u8D25:", error);
      new import_obsidian6.Notice("\u4E3A\u65B0\u6307\u6807\u6DFB\u52A0\u9ED8\u8BA4\u503C\u65F6\u51FA\u73B0\u9519\u8BEF");
    }
  }
  async normalizeMetricWeights() {
    try {
      const metrics = this.plugin.settings.customMetrics;
      if (!metrics || metrics.length === 0) {
        console.log("\u6CA1\u6709\u81EA\u5B9A\u4E49\u6307\u6807\uFF0C\u8DF3\u8FC7\u6743\u91CD\u5F52\u4E00\u5316");
        return;
      }
      const totalWeight = metrics.reduce((sum, metric) => sum + metric.weight, 0);
      if (totalWeight > 0) {
        metrics.forEach((metric) => {
          metric.weight = Math.round(metric.weight / totalWeight * 100);
        });
        console.log(`\u5DF2\u5F52\u4E00\u5316 ${metrics.length} \u4E2A\u6307\u6807\u7684\u6743\u91CD\uFF0C\u603B\u6743\u91CD: 100%`);
      } else {
        const equalWeight = Math.floor(100 / metrics.length);
        metrics.forEach((metric) => {
          metric.weight = equalWeight;
        });
        console.log(`\u603B\u6743\u91CD\u4E3A0\uFF0C\u5DF2\u5E73\u5747\u5206\u914D\u6743\u91CD: ${equalWeight}%`);
      }
      this.plugin.settings.metricWeights = {};
      for (const metric of metrics) {
        this.plugin.settings.metricWeights[metric.id] = metric.weight;
      }
    } catch (error) {
      console.error("\u5F52\u4E00\u5316\u6743\u91CD\u65F6\u51FA\u9519:", error);
      throw error;
    }
  }
  generateMetricId(name) {
    return name.toLowerCase().replace(/[^\w\u4e00-\u9fff]/g, "_").replace(/_+/g, "_").replace(/^_|_$/g, "") || "metric";
  }
  async saveSettings() {
    await this.plugin.saveSettings();
  }
  refresh() {
    try {
      console.log("\u5F00\u59CB\u5237\u65B0\u81EA\u5B9A\u4E49\u6307\u6807\u8BBE\u7F6E\u754C\u9762");
      if (this.contentEl) {
        this.render();
        console.log("\u81EA\u5B9A\u4E49\u6307\u6807\u8BBE\u7F6E\u754C\u9762\u5237\u65B0\u5B8C\u6210");
      } else {
        console.warn("\u5185\u5BB9\u5BB9\u5668\u4E0D\u5B58\u5728\uFF0C\u5C1D\u8BD5\u91CD\u65B0\u521B\u5EFA");
        this.contentEl = this.containerEl.createEl("div", { cls: "custom-metrics-settings-content" });
        this.render();
      }
    } catch (error) {
      console.error("\u5237\u65B0\u81EA\u5B9A\u4E49\u6307\u6807\u8BBE\u7F6E\u754C\u9762\u65F6\u51FA\u9519:", error);
      try {
        if (!this.contentEl) {
          this.contentEl = this.containerEl.createEl("div", { cls: "custom-metrics-settings-content" });
        }
        this.render();
      } catch (renderError) {
        console.error("\u91CD\u65B0\u6E32\u67D3\u4E5F\u5931\u8D25:", renderError);
      }
    }
  }
};

// src/settings/RecommendationSettings.ts
var import_obsidian7 = require("obsidian");
var RecommendationSettings = class {
  constructor(containerEl, plugin) {
    this.containerEl = containerEl;
    this.plugin = plugin;
  }
  render() {
    this.containerEl.createEl("h3", { text: "\u63A8\u8350\u8BBE\u7F6E" });
    new import_obsidian7.Setting(this.containerEl).setName("\u6700\u8FD1\u6D4F\u89C8\u951A\u70B9\u6570\u91CF").setDesc("\u667A\u80FD\u63A8\u8350\u65F6\u4F7F\u7528\u7684\u6700\u8FD1\u6D4F\u89C8\u6587\u6863\u6570\u91CF\uFF08\u4F5C\u4E3A\u63A8\u8350\u57FA\u51C6\uFF09").addSlider((slider) => slider.setLimits(1, 20, 1).setValue(this.plugin.settings.recommendationSettings.recentCount).setDynamicTooltip().onChange(async (value) => {
      this.plugin.settings.recommendationSettings.recentCount = Math.floor(value);
      await this.plugin.saveSettings();
    }));
    new import_obsidian7.Setting(this.containerEl).setName("\u9AD8\u9891\u8BBF\u95EE\u951A\u70B9\u6570\u91CF").setDesc("\u667A\u80FD\u63A8\u8350\u65F6\u4F7F\u7528\u7684\u6F2B\u6E38\u6B21\u6570\u6700\u591A\u7684\u6587\u6863\u6570\u91CF\uFF08\u4F5C\u4E3A\u63A8\u8350\u57FA\u51C6\uFF09").addSlider((slider) => slider.setLimits(1, 20, 1).setValue(this.plugin.settings.recommendationSettings.topCount).setDynamicTooltip().onChange(async (value) => {
      this.plugin.settings.recommendationSettings.topCount = Math.floor(value);
      await this.plugin.saveSettings();
    }));
    new import_obsidian7.Setting(this.containerEl).setName("\u63A8\u8350\u7ED3\u679C\u6570\u91CF").setDesc("\u667A\u80FD\u63A8\u8350\u7B97\u6CD5\u8FD4\u56DE\u7684\u63A8\u8350\u6587\u6863\u6570\u91CF").addSlider((slider) => slider.setLimits(5, 50, 1).setValue(this.plugin.settings.recommendationSettings.topK).setDynamicTooltip().onChange(async (value) => {
      this.plugin.settings.recommendationSettings.topK = Math.floor(value);
      await this.plugin.saveSettings();
    }));
    new import_obsidian7.Setting(this.containerEl).setName("\u6700\u5927\u5019\u9009\u6587\u6863\u6570").setDesc("\u667A\u80FD\u63A8\u8350\u7B97\u6CD5\u8003\u8651\u7684\u6700\u5927\u6587\u6863\u6570\u91CF\uFF08\u5F71\u54CD\u6027\u80FD\u548C\u63A8\u8350\u8D28\u91CF\uFF09").addSlider((slider) => slider.setLimits(50, 500, 10).setValue(this.plugin.settings.maxCandidates).setDynamicTooltip().onChange(async (value) => {
      this.plugin.settings.maxCandidates = Math.floor(value);
      await this.plugin.saveSettings();
    }));
    new import_obsidian7.Setting(this.containerEl).setName("\u6587\u6863\u6BB5\u843D\u91C7\u6837\u6570\u91CF").setDesc("\u667A\u80FD\u63A8\u8350\u65F6\u4ECE\u6BCF\u4E2A\u6587\u6863\u91C7\u6837\u7684\u6BB5\u843D\u6570\u91CF\uFF08\u5305\u542B\u6807\u9898+\u5934/\u4E2D/\u5C3E\u6BB5\u843D\uFF09").addSlider((slider) => slider.setLimits(3, 10, 1).setValue(this.plugin.settings.recommendationSettings.maxParagraphs).setDynamicTooltip().onChange(async (value) => {
      this.plugin.settings.recommendationSettings.maxParagraphs = Math.floor(value);
      await this.plugin.saveSettings();
    }));
  }
};

// src/settings/FilterSettings.ts
var import_obsidian8 = require("obsidian");
var FilterSettings = class {
  constructor(containerEl, plugin) {
    this.containerEl = containerEl;
    this.plugin = plugin;
  }
  render() {
    this.containerEl.createEl("h3", { text: "\u8FC7\u6EE4\u8BBE\u7F6E" });
    new import_obsidian8.Setting(this.containerEl).setName("\u6392\u9664\u8DEF\u5F84").setDesc("\u8981\u4ECE\u6F2B\u6E38\u4E2D\u6392\u9664\u7684\u6587\u4EF6\u5939\u8DEF\u5F84\uFF08\u6BCF\u884C\u4E00\u4E2A\uFF0C\u652F\u6301*\u901A\u914D\u7B26\u5339\u914D\uFF09").addTextArea((text) => text.setPlaceholder("\u793A\u4F8B\uFF1A\nTemplates/*\nArchive/**\n.obsidian/**\n**/*.excalidraw").setValue(this.plugin.settings.excludedPaths.join("\n")).onChange(async (value) => {
      this.plugin.settings.excludedPaths = value.split("\n").filter((p) => p.trim());
      await this.plugin.saveSettings();
    }));
  }
};

// src/settings/DataManagementSettings.ts
var import_obsidian9 = require("obsidian");
var DataManagementSettings = class {
  constructor(containerEl, plugin) {
    this.containerEl = containerEl;
    this.plugin = plugin;
  }
  render() {
    this.containerEl.createEl("h3", { text: "\u6570\u636E\u7BA1\u7406" });
    new import_obsidian9.Setting(this.containerEl).setName("\u6E05\u9664\u6F2B\u6E38\u5386\u53F2").setDesc("\u6E05\u9664\u6240\u6709\u6F2B\u6E38\u5386\u53F2\u8BB0\u5F55\u548C\u8BBF\u95EE\u6B21\u6570\uFF08\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\uFF0C\u8BF7\u8C28\u614E\u64CD\u4F5C\uFF09").addButton((button) => button.setButtonText("\u{1F5D1}\uFE0F \u6E05\u9664\u6240\u6709\u5386\u53F2").onClick(async () => {
      if (confirm("\u786E\u5B9A\u8981\u6E05\u9664\u6240\u6709\u6F2B\u6E38\u5386\u53F2\u5417\uFF1F\n\u8FD9\u5C06\u6E05\u7A7A\u6F2B\u6E38\u5217\u8868\u5E76\u91CD\u7F6E\u6240\u6709\u6587\u6863\u7684\u8BBF\u95EE\u6B21\u6570\u3002\n\n\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\uFF01")) {
        this.plugin.settings.roamingDocs = [];
        for (const [path] of Object.entries(this.plugin.settings.documentMetrics)) {
          this.plugin.settings.documentMetrics[path].visitCount = 0;
          this.plugin.settings.documentMetrics[path].lastVisited = 0;
        }
        await this.plugin.saveSettings();
        new import_obsidian9.Notice("\u2705 \u6240\u6709\u6F2B\u6E38\u5386\u53F2\u5DF2\u6E05\u9664");
      }
    }));
  }
};

// src/main.ts
var IncrementalReadingPlugin = class extends import_obsidian10.Plugin {
  constructor() {
    super(...arguments);
    this.leaf = null;
    this.isUpdatingSettings = false;
  }
  async onload() {
    console.log("Loading Incremental Reading plugin");
    await this.loadSettings();
    this.recommendationService = new RecommendationService(this.app, this.settings);
    this.fileManagementService = new FileManagementService(this.app, this.settings);
    this.documentScoringService = new DocumentScoringService(this.settings);
    this.registerView(
      VIEW_TYPE_INCREMENTAL_READING,
      (leaf) => new IncrementalReadingView(leaf, this)
    );
    this.addRibbonIcon("book-open", "Incremental Reading", () => {
      this.activateView();
    });
    this.addCommands();
    this.addSettingTab(new IncrementalReadingSettingTab(this.app, this));
  }
  onunload() {
    console.log("Unloading Incremental Reading plugin");
  }
  async loadSettings() {
    try {
      const savedSettings = await this.loadData();
      const validatedSettings = SharedUtils.validateSettings(savedSettings);
      this.settings = Object.assign({}, DEFAULT_SETTINGS, validatedSettings);
      if (!this.settings.version || this.settings.version !== DEFAULT_SETTINGS.version) {
        this.settings.roamingDocs = [];
        this.settings.version = DEFAULT_SETTINGS.version;
        await this.saveData(this.settings);
        new import_obsidian10.Notice('\u{1F389} \u6F2B\u6E38\u9605\u8BFB\u529F\u80FD\u5DF2\u5347\u7EA7\uFF01\u8BF7\u4F7F\u7528"\u52A0\u5165\u6F2B\u6E38"\u529F\u80FD\u91CD\u65B0\u6DFB\u52A0\u4F60\u60F3\u6F2B\u6E38\u7684\u6587\u6863');
      }
    } catch (error) {
      console.error("Error loading settings:", error);
      new import_obsidian10.Notice("Error loading settings, using defaults");
      this.settings = { ...DEFAULT_SETTINGS };
    }
  }
  async saveSettings() {
    if (this.isUpdatingSettings) {
      console.warn("Settings update already in progress, skipping");
      return;
    }
    this.isUpdatingSettings = true;
    try {
      const validatedSettings = SharedUtils.validateSettings(this.settings);
      Object.assign(this.settings, validatedSettings);
      await this.saveData(this.settings);
      this.recommendationService = new RecommendationService(this.app, this.settings);
      this.fileManagementService = new FileManagementService(this.app, this.settings);
      this.documentScoringService = new DocumentScoringService(this.settings);
      this.notifyViewsRefresh();
    } catch (error) {
      console.error("Error saving settings:", error);
      new import_obsidian10.Notice("Error saving settings");
    } finally {
      this.isUpdatingSettings = false;
    }
  }
  /**
   * 通知所有增量阅读视图刷新数据
   */
  notifyViewsRefresh() {
    try {
      const leaves = this.app.workspace.getLeavesOfType(VIEW_TYPE_INCREMENTAL_READING);
      leaves.forEach((leaf) => {
        const view = leaf.view;
        if (view && typeof view.refreshData === "function") {
          view.refreshData();
          console.log("\u5DF2\u901A\u77E5\u589E\u91CF\u9605\u8BFB\u89C6\u56FE\u5237\u65B0\u6570\u636E");
        }
      });
    } catch (error) {
      console.error("\u901A\u77E5\u89C6\u56FE\u5237\u65B0\u65F6\u51FA\u9519:", error);
    }
  }
  async activateView() {
    var _a;
    const { workspace } = this.app;
    if (this.leaf) {
      workspace.revealLeaf(this.leaf);
    } else {
      this.leaf = workspace.getRightLeaf(false);
      await ((_a = this.leaf) == null ? void 0 : _a.setViewState({ type: VIEW_TYPE_INCREMENTAL_READING, active: true }));
    }
    workspace.revealLeaf(this.leaf);
  }
  addCommands() {
    this.addCommand({
      id: "start-incremental-reading",
      name: "Start Incremental Reading",
      callback: () => {
        this.activateView();
      }
    });
    this.addCommand({
      id: "open-random-document",
      name: "Open Random Document",
      callback: () => {
        this.openRandomDocument();
      }
    });
    this.addCommand({
      id: "add-to-roaming",
      name: "\u6DFB\u52A0\u81F3\u6F2B\u6E38",
      callback: async () => {
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile) {
          new import_obsidian10.Notice("\u6CA1\u6709\u6253\u5F00\u7684\u6587\u6863");
          return;
        }
        try {
          if (activeFile.extension !== "md") {
            new import_obsidian10.Notice(`\u53EA\u80FD\u6DFB\u52A0Markdown\u6587\u6863\u5230\u6F2B\u6E38\u5217\u8868 "${activeFile.basename}"`);
            return;
          }
          if (!this.settings.roamingDocs.includes(activeFile.path)) {
            this.settings.roamingDocs.push(activeFile.path);
          }
          const defaultMetrics = this.fileManagementService.createDefaultMetricsForFile(activeFile);
          await this.updateDocumentMetrics(activeFile, defaultMetrics);
          await this.saveSettings();
          new import_obsidian10.Notice(`\u5DF2\u5C06 "${activeFile.basename}" \u52A0\u5165\u6F2B\u6E38`);
        } catch (error) {
          console.error("\u52A0\u5165\u6F2B\u6E38\u5931\u8D25:", error);
          new import_obsidian10.Notice("\u52A0\u5165\u6F2B\u6E38\u5931\u8D25");
        }
      }
    });
    this.addCommand({
      id: "add-folder-to-roaming",
      name: "\u6DFB\u52A0\u6587\u4EF6\u5939\u5230\u6F2B\u6E38",
      callback: async () => {
        new import_obsidian10.Notice('\u8BF7\u4F7F\u7528\u754C\u9762\u7684"\u6DFB\u52A0\u6587\u4EF6\u5939"\u6309\u94AE');
      }
    });
    this.addCommand({
      id: "add-multiple-files-to-roaming",
      name: "\u591A\u9009\u6587\u4EF6\u5230\u6F2B\u6E38",
      callback: async () => {
        new import_obsidian10.Notice('\u8BF7\u4F7F\u7528\u754C\u9762\u7684"\u591A\u9009\u6587\u4EF6"\u6309\u94AE');
      }
    });
    this.addCommand({
      id: "reset-visited-documents",
      name: "Clear Reading History",
      callback: async () => {
        this.settings.roamingDocs = [];
        for (const [path] of Object.entries(this.settings.documentMetrics)) {
          this.settings.documentMetrics[path].visitCount = 0;
          this.settings.documentMetrics[path].lastVisited = 0;
        }
        await this.saveSettings();
        new import_obsidian10.Notice("\u6F2B\u6E38\u5386\u53F2\u5DF2\u6E05\u9664");
      }
    });
  }
  async openRandomDocument() {
    try {
      const randomFile = this.fileManagementService.getRandomUnvisitedFile();
      if (!randomFile) {
        new import_obsidian10.Notice("No unvisited documents found");
        return;
      }
      await this.app.workspace.getLeaf().openFile(randomFile);
    } catch (error) {
      console.error("Error opening random document:", error);
      new import_obsidian10.Notice("Error opening random document");
    }
  }
  // 公共方法供视图组件使用
  getDocumentMetrics(file) {
    return this.documentScoringService.getDocumentMetrics(file);
  }
  async updateDocumentMetrics(file, metrics) {
    try {
      const validatedMetrics = this.documentScoringService.validateMetrics(metrics);
      const updatedMetrics = this.documentScoringService.updateDocumentMetrics(file, validatedMetrics);
      this.settings.documentMetrics[file.path] = updatedMetrics;
      await this.saveSettings();
    } catch (error) {
      console.error("Error updating document metrics:", error);
      new import_obsidian10.Notice("Error updating document metrics");
    }
  }
  getRecommendedDocuments(limit = 10) {
    try {
      const validRoamingPaths = this.fileManagementService.getValidRoamingPaths();
      const validRoamingFiles = this.fileManagementService.getValidRoamingFiles();
      const filteredFiles = validRoamingFiles.filter(
        (file) => this.fileManagementService.shouldIncludeFile(file)
      );
      return this.documentScoringService.getRecommendedDocuments(filteredFiles, limit);
    } catch (error) {
      console.error("Error getting recommended documents:", error);
      return [];
    }
  }
  // 公开服务实例
  get FileManagementService() {
    return this.fileManagementService;
  }
  get DocumentScoringService() {
    return this.documentScoringService;
  }
  // 向后兼容的方法
  getValidRoamingFiles() {
    return this.fileManagementService.getValidRoamingFiles();
  }
  getValidRoamingPaths() {
    return this.fileManagementService.getValidRoamingPaths();
  }
  async addFoldersToRoaming(folderPaths) {
    try {
      const addedCount = await this.fileManagementService.addFoldersToRoaming(folderPaths);
      await this.saveSettings();
      new import_obsidian10.Notice(`\u6210\u529F\u6DFB\u52A0 ${addedCount} \u4E2A\u6587\u4EF6\u5230\u6F2B\u6E38\u5217\u8868`);
    } catch (error) {
      console.error("\u6DFB\u52A0\u6587\u4EF6\u5939\u5931\u8D25:", error);
      new import_obsidian10.Notice("\u6DFB\u52A0\u6587\u4EF6\u5939\u5931\u8D25");
    }
  }
  async addMultipleFilesToRoaming(files) {
    try {
      const addedCount = await this.fileManagementService.addMultipleFilesToRoaming(files);
      await this.saveSettings();
      new import_obsidian10.Notice(`\u6210\u529F\u6DFB\u52A0 ${addedCount} \u4E2A\u6587\u4EF6\u5230\u6F2B\u6E38\u5217\u8868`);
    } catch (error) {
      console.error("\u6DFB\u52A0\u6587\u4EF6\u5931\u8D25:", error);
      new import_obsidian10.Notice("\u6DFB\u52A0\u6587\u4EF6\u5931\u8D25");
    }
  }
};
var IncrementalReadingSettingTab = class extends import_obsidian10.PluginSettingTab {
  constructor(app, plugin) {
    super(app, plugin);
    this.plugin = plugin;
  }
  async display() {
    const { containerEl } = this;
    containerEl.empty();
    containerEl.addClass("setting-tab-content");
    containerEl.addClass("incremental-reading-settings");
    containerEl.addClass("incremental-reading-plugin-root");
    containerEl.createEl("h2", { text: "\u589E\u91CF\u9605\u8BFB \u63D2\u4EF6\u8BBE\u7F6E" });
    const customMetricsSettings = new CustomMetricsSettings(containerEl, this.plugin);
    customMetricsSettings.render();
    const recommendationSettings = new RecommendationSettings(containerEl, this.plugin);
    recommendationSettings.render();
    const filterSettings = new FilterSettings(containerEl, this.plugin);
    filterSettings.render();
    const dataManagementSettings = new DataManagementSettings(containerEl, this.plugin);
    dataManagementSettings.render();
  }
};
